    // Firebase SDK Imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut, // Kept for completeness, though not used on login page itself
        onAuthStateChanged, // Useful for redirecting if already logged in
        GoogleAuthProvider,
        signInWithPopup,
        sendPasswordResetEmail
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
        getFirestore,
        doc,
        setDoc,
        getDoc
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // Firebase configuration (ENSURE THESE ARE YOUR ACTUAL KEYS)
    const firebaseConfig = {
        apiKey: "AIzaSyDASGZnUyav23Mte5Q96H0j-T3LlGzVK-k",
        authDomain: "safetyfirst2025-aea34.firebaseapp.com",
        projectId: "safetyfirst2025-aea34",
        storageBucket: "safetyfirst2025-aea34.appspot.com",
        messagingSenderId: "620306944192",
        appId: "1:620306944192:web:ddadeef6825901068a9d25",
        measurementId: "G-VQL1FCD8NN"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- UI Management & Message Display ---
    function displayMessage(messageKey, type, elementId = "auth-message", persistShort = false) {
        const messageContainer = document.getElementById(elementId);
        if (messageContainer) {
            const translatedMessage = (typeof i18next !== 'undefined' && i18next.isInitialized) ? i18next.t(messageKey) : messageKey;
            messageContainer.textContent = translatedMessage;
            messageContainer.className = ''; // Reset classes
            messageContainer.classList.add('p-3', 'my-2', 'rounded-md', 'text-center', 'text-sm');
            if (type === 'success') {
                messageContainer.classList.add('message-success'); // Should be green
            } else {
                messageContainer.classList.add('message-error'); // Should be red
            }
            messageContainer.style.display = 'block';

            if (!persistShort) { // Only hide if not persisting for redirect
                setTimeout(() => {
                    messageContainer.style.display = 'none';
                }, 7000); // Slightly longer display for errors
            }
        } else {
            console.warn(`Message container with ID '${elementId}' not found. Message: ${messageKey}`);
        }
    }

    // --- Authentication Functions ---
    async function handleEmailPasswordSignUp(email, password, displayName, companyName = '') {
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            await setDoc(doc(db, "users", user.uid), {
                uid: user.uid,
                email: user.email,
                displayName: displayName || user.email.split('@')[0], // Use part of email if display name is empty
                companyName: companyName,
                membershipPlan: 'free',
                role: 'client',
                createdAt: new Date()
            });
            console.log("User registered and data saved to Firestore:", user.uid);
            displayMessage("signup.emailSuccessRedirect", "success", "auth-message", true); // persistShort = true
            setTimeout(() => { window.location.href = '/SafetyHelp/secure/member-dashboard.html'; }, 2000);
        } catch (error) {
            console.error("Error during sign up:", error.code, error.message);
            let errorMessageKey = "signup.errorGeneral";
            if (error.code === 'auth/email-already-in-use') errorMessageKey = "signup.errorEmailInUse";
            else if (error.code === 'auth/invalid-email') errorMessageKey = "signup.errorInvalidEmail";
            else if (error.code === 'auth/weak-password') errorMessageKey = "signup.errorWeakPassword";
            displayMessage(errorMessageKey, "error", "auth-message");
        }
    }

    async function handleEmailPasswordSignIn(email, password) {
        try {
            await signInWithEmailAndPassword(auth, email, password);
            console.log("User signed in successfully!");
            displayMessage("login.emailSuccessRedirect", "success", "auth-message", true); // persistShort = true
            setTimeout(() => { window.location.href = '/SafetyHelp/secure/member-dashboard.html'; }, 2000);
        } catch (error) {
            console.error("Error during sign in:", error.code, error.message);
            let errorMessageKey = "login.errorGeneral";
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                errorMessageKey = "login.errorInvalidCredentials";
            } else if (error.code === 'auth/invalid-email') {
                errorMessageKey = "login.errorInvalidEmail";
            }
            displayMessage(errorMessageKey, "error", "auth-message");
        }
    }

    async function handleGoogleAuth(isSignUpFlow) { // isSignUpFlow helps tailor messages slightly
        try {
            const provider = new GoogleAuthProvider();
            const userCredential = await signInWithPopup(auth, provider);
            const user = userCredential.user;
            const userDocRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(userDocRef);

            let successMessageKey = "";
            if (!docSnap.exists()) { // New user
                await setDoc(userDocRef, {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName || user.email.split('@')[0],
                    companyName: '', 
                    membershipPlan: 'free',
                    role: 'client',
                    createdAt: new Date(),
                    authMethod: 'google'
                });
                console.log("New user registered via Google:", user.uid);
                successMessageKey = "signup.googleSuccessRedirect";
            } else { // Existing user
                console.log("Existing user signed in with Google:", user.uid);
                successMessageKey = "login.googleSuccessRedirect";
            }
            displayMessage(successMessageKey, "success", "auth-message", true); // persistShort = true
            setTimeout(() => { window.location.href = '/SafetyHelp/secure/member-dashboard.html'; }, 2000);
        } catch (error) {
            console.error("Error during Google sign in/up:", error.code, error.message);
            let errorMessageKey = "login.errorGoogleGeneral";
            if (error.code === 'auth/popup-closed-by-user') errorMessageKey = "login.errorGooglePopupClosed";
            else if (error.code === 'auth/cancelled-popup-request') errorMessageKey = "login.errorGoogleCancelled";
            displayMessage(errorMessageKey, "error", "auth-message");
        }
    }

    async function handlePasswordReset(email) {
        if (!email || !email.trim()) { // Check if email is empty or just whitespace
            displayMessage("login.errorEmailRequiredForReset", "error", "auth-message");
            return;
        }
        try {
            await sendPasswordResetEmail(auth, email);
            displayMessage("login.passwordResetSent", "success", "auth-message");
        } catch (error) {
            console.error("Error sending password reset email:", error);
            let errorMessageKey = "login.errorPasswordResetFailed";
            if (error.code === 'auth/user-not-found') errorMessageKey = "login.errorUserNotFoundForReset";
            else if (error.code === 'auth/invalid-email') errorMessageKey = "login.errorInvalidEmail";
            displayMessage(errorMessageKey, "error", "auth-message");
        }
    }

    // --- i18next Initialization and Content Update ---
    async function initializeI18next() {
        if (typeof i18next !== 'undefined' && typeof i18nextHttpBackend !== 'undefined' && typeof i18nextBrowserLanguageDetector !== 'undefined') {
            try {
                await i18next
                    .use(i18nextHttpBackend)
                    .use(i18nextBrowserLanguageDetector)
                    .init({
                        fallbackLng: 'en',
                        debug: false, // Set to false in production for cleaner console
                        ns: ['translation'],
                        defaultNS: 'translation',
                        backend: { loadPath: '/SafetyHelp/assets/locales/{{lng}}/{{ns}}.json' },
                        detection: { order: ['querystring', 'cookie', 'localStorage', 'sessionStorage', 'navigator', 'htmlTag'], caches: ['localStorage', 'cookie'] }
                    });
                updateContent();
            } catch (error) {
                console.error("Error initializing i18next:", error);
                applyStaticTranslations(); 
            }
        } else {
            console.error("i18next or its plugins are not loaded. Applying static translations.");
            applyStaticTranslations();
        }
    }

    function updateContent() {
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            const optionsAttr = element.getAttribute('data-i18n-options');
            let options = {};
            if (optionsAttr) { try { options = JSON.parse(optionsAttr); } catch (e) { console.error(`Error parsing i18n options for key "${key}":`, e); }}
            
            let translation = i18next.t(key, options);

            if (key.startsWith('[placeholder]')) {
                 element.setAttribute('placeholder', translation);
            } else if (element.tagName === 'TITLE') {
                document.title = translation;
            } else {
                const icon = element.querySelector('i.fas, i.fab');
                if (icon) {
                    let textNode = icon.nextSibling;
                    while(textNode && textNode.nodeType !== Node.TEXT_NODE) { textNode = textNode.nextSibling; }
                    if (textNode) { textNode.textContent = ' ' + translation; }
                    else { element.appendChild(document.createTextNode(' ' + translation));}
                } else {
                    element.innerHTML = translation;
                }
            }
        });
        const footerYear = document.getElementById('copyright-year');
        if(footerYear && i18next.isInitialized) footerYear.textContent = i18next.t('footer.copyright_year', { year: new Date().getFullYear() });
    }
    
    function applyStaticTranslations() { 
        console.warn("Applying static/fallback translations for login page.");
        document.title = "Login / SignUp | SafetyHelp";
        // Add more static fallbacks if necessary for critical elements
    }

    // --- Form Toggling ---
    const loginFormEl = document.getElementById('loginForm');
    const signupFormEl = document.getElementById('signupForm');
    const showLoginBtn = document.getElementById('show-login-btn');
    const showSignupBtn = document.getElementById('show-signup-btn');
    const authMessageDiv = document.getElementById('auth-message');

    if (showLoginBtn && showSignupBtn && loginFormEl && signupFormEl) {
        showLoginBtn.addEventListener('click', () => {
            loginFormEl.classList.remove('hidden');
            signupFormEl.classList.add('hidden');
            showLoginBtn.classList.add('active');
            showSignupBtn.classList.remove('active');
            if(authMessageDiv) authMessageDiv.style.display = 'none'; 
        });
        showSignupBtn.addEventListener('click', () => {
            signupFormEl.classList.remove('hidden');
            loginFormEl.classList.add('hidden');
            showSignupBtn.classList.add('active');
            showLoginBtn.classList.remove('active');
            if(authMessageDiv) authMessageDiv.style.display = 'none';
        });
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', async () => {
        await initializeI18next();
        
        // Check auth state on load - if user is already logged in, redirect to dashboard
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User already logged in, redirecting to dashboard.");
                // Optional: Display a brief "Already logged in" message
                // displayMessage("login.alreadyLoggedIn", "success", "auth-message", true);
                // setTimeout(() => { window.location.href = '/SafetyHelp/secure/member-dashboard.html'; }, 1000);
            }
        });

        const langSelect = document.getElementById('language-switcher-header');
        if (langSelect && typeof i18next !== 'undefined' && i18next.isInitialized) {
            const currentLang = i18next.language.split('-')[0];
            if (Array.from(langSelect.options).some(opt => opt.value === currentLang)) { 
                langSelect.value = currentLang; 
            }
            langSelect.addEventListener('change', (e) => {
                i18next.changeLanguage(e.target.value, (err) => {
                    if (err) { console.error('Error changing language:', err); return; }
                    updateContent();
                });
            });
        }

        if (loginFormEl) {
            loginFormEl.addEventListener('submit', async (event) => {
                event.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                await handleEmailPasswordSignIn(email, password);
            });
        }

        if (signupFormEl) {
            signupFormEl.addEventListener('submit', async (event) => {
                event.preventDefault();
                const displayName = document.getElementById('signup-displayName').value;
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const companyName = document.getElementById('signup-company').value;
                await handleEmailPasswordSignUp(email, password, displayName, companyName);
            });
        }
        
        const googleLoginButton = document.getElementById('google-login-btn');
        if (googleLoginButton) {
            googleLoginButton.addEventListener('click', () => handleGoogleAuth(false)); // false indicates a login attempt context
        }
        const googleSignupButton = document.getElementById('google-signup-btn');
        if (googleSignupButton) {
            googleSignupButton.addEventListener('click', () => handleGoogleAuth(true)); // true indicates a signup attempt context
        }

        const forgotPasswordLink = document.getElementById('forgot-password-link');
        if (forgotPasswordLink) {
            forgotPasswordLink.addEventListener('click', async (event) => {
                event.preventDefault();
                const promptMessage = i18next.isInitialized ? i18next.t('login.promptForgotPasswordEmail') : "Please enter your email address to reset your password:";
                const email = prompt(promptMessage);
                if (email) { await handlePasswordReset(email); }
                else if (email === "") { displayMessage("login.errorEmailRequiredForReset", "error", "auth-message");}
            });
        }

        const newsletterForm = document.getElementById('newsletterForm');
        if (newsletterForm) {
            newsletterForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const emailEl = document.getElementById('newsletterEmail');
                if (emailEl && emailEl.value) {
                    const successMsgKey = i18next.isInitialized ? i18next.t('footer.newsletter.success', {email: emailEl.value}) : `Subscribed ${emailEl.value}!`;
                    displayMessage(successMsgKey, "success", "auth-message"); // Use auth-message for newsletter feedback too
                    emailEl.value = '';
                } else {
                    const errorMsgKey = i18next.isInitialized ? i18next.t('footer.newsletter.error') : "Please enter a valid email.";
                    displayMessage(errorMsgKey, "error", "auth-message");
                }
            });
        }
        
        if (loginFormEl && showLoginBtn) {
            loginFormEl.classList.remove('hidden');
            showLoginBtn.classList.add('active');
        }
        if (signupFormEl && showSignupBtn) {
            signupFormEl.classList.add('hidden');
            showSignupBtn.classList.remove('active');
        }
    });
    
    // --- Sidebar and common UI (from existing template, simplified as not primary focus here) ---
    document.getElementById('copyright-year').textContent = new Date().getFullYear();

    function setupMilestonesSidebar() {
        const listElement = document.getElementById('ohs-milestones-list');
        if (!listElement || listElement.children.length === 0) return;
        const originalItems = Array.from(listElement.children);
        originalItems.forEach(item => {
            const clone = item.cloneNode(true);
            clone.addEventListener('click', () => showMilestoneDetail(clone));
            listElement.appendChild(clone);
        });
        originalItems.forEach(item => {
            item.addEventListener('click', () => showMilestoneDetail(item));
        });
    }
    
    const infoModal = document.getElementById('infoModal');
    const infoModalTitle = document.getElementById('modalTitle');
    const infoModalBody = document.getElementById('modalBody');

    function showMilestoneDetail(element) {
        if (!infoModal || !infoModalTitle || !infoModalBody) return;
        const title = element.textContent.trim().replace(/^.*? /,''); 
        const detail = element.dataset.detail || "More information about this milestone will be available soon.";
        infoModalTitle.textContent = `OHS Milestone: ${title}`;
        infoModalBody.innerHTML = `<p>${detail}</p>`;
        infoModal.style.display = 'block';
    }
    function closeModal() {
        if (infoModal) infoModal.style.display = 'none';
    }
    window.onclick = function(event) {
        if (event.target == infoModal) { closeModal(); }
    }
    
    const chatWindowEl = document.getElementById('chat-window'); // Renamed to avoid conflict
    const chatToggleBtnEl = document.getElementById('chat-toggle'); // Renamed
    const chatInputElMain = document.getElementById('chat-input');  // Renamed
    const chatSendBtnEl = document.getElementById('chat-send');    // Renamed
    const chatOutputElMain = document.getElementById('chat-output'); // Renamed

    function toggleChatbot(forceOpen) {
        if (!chatWindowEl || !chatToggleBtnEl) return;
        const isHidden = chatWindowEl.classList.contains('chat-hidden');
        if (forceOpen === true || isHidden) {
            chatWindowEl.classList.remove('chat-hidden');
            chatWindowEl.classList.add('chat-expanded');
            chatToggleBtnEl.innerHTML = '<i class="fas fa-times"></i>'; 
            if (chatInputElMain) chatInputElMain.focus();
        } else if (forceOpen === false || !isHidden) {
            chatWindowEl.classList.add('chat-hidden');
            chatWindowEl.classList.remove('chat-expanded');
            chatToggleBtnEl.innerHTML = '<i class="fas fa-headset"></i>'; 
        }
    }

    function addChatMessageToUIChatbot(sender, message, isUser) {
        if (!chatOutputElMain) return;
        const p = document.createElement('p');
        p.innerHTML = `<strong>${sender}:</strong> ${message}`;
        if(isUser) p.style.textAlign = "right"; 
        chatOutputElMain.appendChild(p);
        chatOutputElMain.scrollTop = chatOutputElMain.scrollHeight;
    }

    async function handleChatSendMain() {
        if(!chatInputElMain || !chatOutputElMain) return;
        const message = chatInputElMain.value.trim();
        if (message) {
            addChatMessageToUIChatbot('You', message, true);
            chatInputElMain.value = '';
            let botResponse = "How can I help you with login or signup? (Chatbot placeholder)";
            if (message.toLowerCase().includes("forgot password")) {
                botResponse = "If you forgot your password, click the 'Forgot your Password?' link under the login form. You'll be prompted to enter your email to receive a reset link.";
            }
            setTimeout(() => { addChatMessageToUIChatbot('Salatiso', botResponse, false); }, 500);
        }
    }

    if(chatSendBtnEl) chatSendBtnEl.addEventListener('click', handleChatSendMain);
    if(chatInputElMain) chatInputElMain.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleChatSendMain(); });
    
    window.addEventListener('load', () => { 
        setupMilestonesSidebar(); 
        if (chatWindowEl) chatWindowEl.classList.add('chat-hidden');
        if (chatToggleBtnEl) chatToggleBtnEl.style.display = 'flex'; 
    });
</script>

</body>
</html>
