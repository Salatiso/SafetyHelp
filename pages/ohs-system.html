import React, { useState, useEffect, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, updateDoc, deleteDoc, serverTimestamp, query, where, getDocs, onSnapshot } from 'firebase/firestore';
import { ChevronDown, ChevronRight, CheckCircle, AlertTriangle, Info, FileText, Edit3, ShoppingCart, ArrowLeft, LogOut, UserPlus, LogIn, Save, Home, ListChecks, Edit, Search, Settings, HelpCircle, Briefcase, Users, CalendarDays, Building, ShieldCheck, FilePlus, Eye, Trash2, Download, DollarSign, Tag, Check, X, ExternalLink, Printer, CreditCard, RotateCcw } from 'lucide-react';

// --- Firebase Configuration ---
// IMPORTANT: When deploying to your own hosting (like GitHub Pages), 
// you MUST replace these placeholder values with your actual Firebase project configuration.
// The __firebase_config and __app_id variables are for the Canvas environment.
const firebaseConfig = {
    apiKey: "YOUR_API_KEY", 
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

const effectiveFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-ohs-builder-app'; // Renamed to avoid conflict with firebaseConfig.appId

const app = initializeApp(effectiveFirebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
// import { setLogLevel } from 'firebase/firestore'; // Uncomment for debugging
// setLogLevel('debug'); 

// --- Rich Text Editor (React Quill) ---
// For deployment without a build step (like in a single HTML file):
// ReactQuill's `require` will not work. The fallback is a simple textarea.
// To use the rich text editor, you would need to include ReactQuill's UMD build and CSS from a CDN 
// in your main HTML file. Example:
// <link href="https://cdn.jsdelivr.net/npm/react-quill@2.0.0/dist/quill.snow.css" rel="stylesheet">
// <script src="https://cdn.jsdelivr.net/npm/react-quill@2.0.0/dist/react-quill.js"></script>
// Then, ensure ReactQuill is available on the window object.
let ReactQuill;
try {
    ReactQuill = require('react-quill'); // This works in environments that support CommonJS (like Node/bundlers)
    require('react-quill/dist/quill.snow.css');
} catch (e) {
    console.warn("ReactQuill not found via require. Document editing will use a simple textarea. For rich text in a no-build setup, include ReactQuill via CDN.");
    ReactQuill = ({ value, onChange, placeholder }) => ( // Added placeholder prop
        <textarea
            className="w-full h-64 p-2 border rounded-md"
            value={value}
            onChange={(e) => onChange(e.target.value)}
            placeholder={placeholder || "Document content editor (ReactQuill not loaded)"}
        />
    );
}

// --- Context API for Global State ---
const AppContext = createContext();

const AppProvider = ({ children }) => {
    const [user, setUser] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [currentStep, setCurrentStep] = useState('welcome');
    const [wizardData, setWizardData] = useState({});
    const [manualSelections, setManualSelections] = useState({});
    const [reportData, setReportData] = useState({});
    const [companyInfo, setCompanyInfo] = useState({});
    const [personInfo, setPersonInfo] = useState({});
    const [cart, setCart] = useState([]);
    const [systemId, setSystemId] = useState(null);
    const [isLoading, setIsLoading] = useState(false);
    const [showModal, setShowModal] = useState(null);
    const [invoiceDetails, setInvoiceDetails] = useState(null);

    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async (firebaseUser) => {
            if (firebaseUser) {
                setUser(firebaseUser);
                setUserId(firebaseUser.uid);
            } else {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            }
            setIsAuthReady(true);
        });
        return () => unsubscribe();
    }, []);
    
    useEffect(() => {
        if (isAuthReady && auth.currentUser && !userId) {
            setUserId(auth.currentUser.uid);
        }
    }, [isAuthReady, auth.currentUser, userId]); // Added auth.currentUser as dependency

    const resetState = () => {
        setWizardData({});
        setManualSelections({});
        setReportData({});
        setCompanyInfo({});
        setPersonInfo({});
        setCart([]);
        setSystemId(null);
        // Keep invoiceDetails for the confirmation screen, it will be cleared by ConfirmationScreen's useEffect cleanup
    };

    const navigateToStep = (step) => {
        window.scrollTo(0, 0);
        setCurrentStep(step);
    };
    
    const getPrivateSpacePath = (path) => `/artifacts/${currentAppId}/users/${userId}/${path}`;
    const getPublicSpacePath = (path) => `/artifacts/${currentAppId}/public/data/${path}`;

    const handleGoToMain = () => {
        if (Object.keys(wizardData).length > 0 || Object.keys(manualSelections).length > 0 || Object.keys(reportData).length > 0 || cart.length > 0) {
            setShowModal({
                type: 'saveOrLoseProgress',
                title: 'Unsaved Progress',
                message: 'You have unsaved progress. Would you like to save it before returning to the main page? Unsaved progress will be lost.',
                onSave: async () => {
                    if (!user || user.isAnonymous) {
                        setShowModal({
                            type: 'registerToSave',
                            title: 'Register to Save',
                            message: 'Please register for a free account to save your progress and access your documents anytime.',
                            onConfirm: () => { setShowModal(null); navigateToStep('register'); },
                            onCancel: () => { setShowModal(null); resetState(); navigateToStep('welcome'); }
                        });
                    } else {
                        await saveSystemData();
                        setShowModal(null);
                        resetState();
                        navigateToStep('welcome');
                    }
                },
                onDiscard: () => { setShowModal(null); resetState(); navigateToStep('welcome'); },
                onCancel: () => setShowModal(null)
            });
        } else {
            resetState();
            navigateToStep('welcome');
        }
    };

    const allDocuments = { 
        policy: [
            { id: 'ohs_policy', name: 'OHS Policy Statement', price: 50, category: 'OHS Policy' },
        ],
        planning: [
            { id: 'hazard_identification', name: 'Hazard Identification & Risk Assessment Procedure', price: 75, category: 'Planning' },
            { id: 'legal_register', name: 'Legal & Other Requirements Register', price: 60, category: 'Planning' },
            { id: 'objectives_targets', name: 'OHS Objectives & Targets', price: 45, category: 'Planning' },
        ],
        implementation: [
            { id: 'roles_responsibilities', name: 'Roles, Responsibilities & Authorities', price: 55, category: 'Implementation & Operation' },
            { id: 'training_procedure', name: 'Training, Awareness & Competence Procedure', price: 65, category: 'Implementation & Operation' },
            { id: 'communication_procedure', name: 'Communication Procedure', price: 50, category: 'Implementation & Operation' },
            { id: 'document_control', name: 'Document Control Procedure', price: 50, category: 'Implementation & Operation' },
            { id: 'emergency_preparedness', name: 'Emergency Preparedness & Response Plan', price: 80, category: 'Implementation & Operation' },
        ],
        checking: [
            { id: 'monitoring_measurement', name: 'Monitoring & Measurement Procedure', price: 70, category: 'Checking' },
            { id: 'internal_audit', name: 'Internal Audit Procedure', price: 75, category: 'Checking' },
            { id: 'nonconformity_corrective_action', name: 'Nonconformity, Corrective & Preventive Action Procedure', price: 65, category: 'Checking' },
        ],
        review: [
            { id: 'management_review', name: 'Management Review Procedure', price: 60, category: 'System Review' },
        ],
    };

    const getDocumentContentTemplate = (docId) => {
        const doc = Object.values(allDocuments).flat().find(d => d.id === docId);
        let content = `<h1>${doc?.name || 'Document'}</h1>\n<p>Company Name: ${companyInfo.name || '[Company Name]'}</p>\n`;
        content += `<p>This document outlines the ${doc?.name?.toLowerCase() || 'procedures'} for ${companyInfo.name || '[Company Name]'}.</p>\n`;
        content += `<h2>1. Purpose</h2><p>[Insert purpose here]</p>\n`;
        content += `<h2>2. Scope</h2><p>[Insert scope here]</p>\n`;
        content += `<h2>3. Responsibilities</h2><p>[Insert responsibilities here]</p>\n`;
        content += `<h2>4. Procedure</h2><p>[Insert procedure details here]</p>\n`;
        content += `<p>Compiled by: ${personInfo.fullName || '[Compiler Name]'}</p>`;
        content += `<p>Date: ${new Date().toLocaleDateString()}</p>`;
        return content;
    };

    const saveSystemData = async () => {
        if (!userId) {
            setShowModal({ type: 'error', title: 'Authentication Error', message: 'You must be logged in to save data.' });
            return;
        }
        setIsLoading(true);
        const cartWithContent = cart.map(item => ({
            ...item,
            content: item.content || getDocumentContentTemplate(item.id) 
        }));

        const currentSystemData = {
            wizardData,
            manualSelections,
            reportData,
            companyInfo,
            personInfo,
            cart: cartWithContent,
            lastUpdated: serverTimestamp(),
            userId: userId,
            status: 'in-progress', 
        };
         if (systemId) { 
            try {
                const existingDocSnap = await getDoc(doc(db, getPrivateSpacePath(`systems/${systemId}`)));
                if (existingDocSnap.exists() && existingDocSnap.data().status) {
                    currentSystemData.status = existingDocSnap.data().status;
                }
            } catch (e) { console.warn("Could not fetch existing system status:", e); }
        }

        try {
            if (systemId) {
                await updateDoc(doc(db, getPrivateSpacePath(`systems/${systemId}`)), currentSystemData);
            } else {
                const docRef = await addDoc(collection(db, getPrivateSpacePath('systems')), currentSystemData);
                setSystemId(docRef.id);
            }
            setShowModal({ type: 'success', title: 'Progress Saved', message: 'Your progress has been successfully saved.' });
        } catch (error) {
            console.error("Error saving system data to Firestore:", error);
            setShowModal({ type: 'error', title: 'Save Error', message: `Failed to save progress: ${error.message}` });
        } finally {
            setIsLoading(false);
        }
    };
    
    return (
        <AppContext.Provider value={{
            user, setUser, userId, setUserId, isAuthReady,
            currentStep, navigateToStep,
            wizardData, setWizardData,
            manualSelections, setManualSelections,
            reportData, setReportData,
            companyInfo, setCompanyInfo,
            personInfo, setPersonInfo,
            cart, setCart,
            systemId, setSystemId,
            isLoading, setIsLoading,
            showModal, setShowModal,
            allDocuments, getDocumentContentTemplate,
            handleGoToMain, saveSystemData,
            resetState,
            invoiceDetails, setInvoiceDetails,
            getPrivateSpacePath, getPublicSpacePath 
        }}>
            {children}
        </AppContext.Provider>
    );
};

const Button = ({ onClick, children, variant = 'primary', className = '', iconLeft, iconRight, type = 'button', disabled = false }) => {
    const baseStyle = "px-6 py-3 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-opacity-75 transition-all duration-150 ease-in-out flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed";
    const variants = {
        primary: "bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500",
        secondary: "bg-gray-200 hover:bg-gray-300 text-gray-800 focus:ring-gray-400",
        danger: "bg-red-500 hover:bg-red-600 text-white focus:ring-red-400",
        success: "bg-green-500 hover:bg-green-600 text-white focus:ring-green-400",
        outline: "bg-transparent hover:bg-blue-50 border border-blue-600 text-blue-600 focus:ring-blue-500",
        ghost: "bg-transparent hover:bg-gray-100 text-gray-700 focus:ring-gray-300",
    };
    return (
        <button type={type} onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`} disabled={disabled}>
            {iconLeft && <span className="mr-2">{iconLeft}</span>}
            {children}
            {iconRight && <span className="ml-2">{iconRight}</span>}
        </button>
    );
};

const Input = ({ label, id, type = 'text', value, onChange, placeholder, required = false, error, helpText, icon }) => (
    <div className="mb-4">
        {label && <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">{label} {required && <span className="text-red-500">*</span>}</label>}
        <div className="relative rounded-md shadow-sm">
            {icon && <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">{icon}</div>}
            <input
                type={type}
                id={id}
                name={id}
                value={value || ''} 
                onChange={onChange}
                placeholder={placeholder}
                required={required}
                className={`block w-full px-4 py-3 border ${error ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${icon ? 'pl-10' : ''}`}
            />
        </div>
        {helpText && !error && <p className="mt-1 text-xs text-gray-500">{helpText}</p>}
        {error && <p className="mt-1 text-xs text-red-500">{error}</p>}
    </div>
);

const Select = ({ label, id, value, onChange, options, required = false, error, helpText }) => (
    <div className="mb-4">
        {label && <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">{label} {required && <span className="text-red-500">*</span>}</label>}
        <select
            id={id}
            name={id}
            value={value || ''} 
            onChange={onChange}
            required={required}
            className={`block w-full px-4 py-3 border ${error ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white`}
        >
            <option value="" disabled>{`Select ${label || 'an option'}...`}</option>
            {options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
        </select>
        {helpText && !error && <p className="mt-1 text-xs text-gray-500">{helpText}</p>}
        {error && <p className="mt-1 text-xs text-red-500">{error}</p>}
    </div>
);

const Checkbox = ({ label, id, checked, onChange, helpText }) => (
    <div className="flex items-start mb-3">
        <div className="flex items-center h-5">
            <input
                id={id}
                name={id}
                type="checkbox"
                checked={checked || false} 
                onChange={onChange}
                className="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
            />
        </div>
        <div className="ml-3 text-sm">
            <label htmlFor={id} className="font-medium text-gray-700">{label}</label>
            {helpText && <p className="text-gray-500 text-xs">{helpText}</p>}
        </div>
    </div>
);

const Modal = ({ title, children, onClose, footer }) => (
    <div className="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-lg transform transition-all">
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-2xl font-semibold text-gray-800">{title}</h3>
                <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors">
                    <X size={24} />
                </button>
            </div>
            <div className="text-gray-600 mb-6">
                {children}
            </div>
            {footer && <div className="flex justify-end space-x-3">{footer}</div>}
        </div>
    </div>
);

const InfoTile = ({ icon, title, description, onClick, className = '' }) => (
    <div
        className={`bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 cursor-pointer border border-gray-200 hover:border-blue-500 ${className}`}
        onClick={onClick}
    >
        <div className="flex items-center text-blue-600 mb-3">
            {icon}
            <h3 className="ml-3 text-xl font-semibold text-gray-800">{title}</h3>
        </div>
        <p className="text-gray-600 text-sm">{description}</p>
        <div className="mt-4 text-right">
            <ChevronRight size={20} className="inline text-blue-600"/>
        </div>
    </div>
);

const StepIndicator = ({ current, total, stepNames = [] }) => (
    <nav aria-label="Progress" className="mb-8">
        <ol role="list" className="flex items-center space-x-2 sm:space-x-4">
            {Array.from({ length: total }).map((_, index) => (
                <li key={index} className="flex-1">
                    {index < current -1 ? ( 
                        <div className="group flex flex-col items-center w-full">
                             <span className="flex items-center justify-center w-10 h-10 rounded-full bg-blue-600">
                                <Check size={20} className="text-white" />
                            </span>
                            {stepNames[index] && <span className="mt-1 text-xs font-medium text-blue-600 text-center">{index+1}. {stepNames[index]}</span>}
                        </div>
                    ) : index === current -1 ? ( 
                         <div className="flex flex-col items-center w-full" aria-current="step">
                            <span className="flex items-center justify-center w-10 h-10 rounded-full border-2 border-blue-600 bg-blue-100">
                                <span className="text-blue-600 font-semibold">{index + 1}</span>
                            </span>
                             {stepNames[index] && <span className="mt-1 text-xs font-medium text-blue-600 text-center">{index+1}. {stepNames[index]}</span>}
                        </div>
                    ) : ( 
                         <div className="group flex flex-col items-center w-full">
                            <span className="flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-300 bg-gray-50">
                                <span className="text-gray-500">{index + 1}</span>
                            </span>
                             {stepNames[index] && <span className="mt-1 text-xs font-medium text-gray-500 text-center">{index+1}. {stepNames[index]}</span>}
                        </div>
                    )}
                    {index < total - 1 && (
                        <div className={`flex-auto border-t-2 transition-colors duration-500 ease-in-out ${index < current -1 ? 'border-blue-600' : 'border-gray-300'} -ml-2 -mr-2 relative top-[-30px] sm:top-[-30px] -z-10`} />
                    )}
                </li>
            ))}
        </ol>
    </nav>
);

const InfoCard = ({ title, children, icon, imageSrc, imageAlt = "Informative image" }) => (
    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 md:p-6 my-6 shadow">
        <div className="flex items-start">
            {icon && <div className="text-blue-600 mr-3 mt-1">{icon}</div>}
            <div>
                {title && <h4 className="text-lg font-semibold text-blue-700 mb-2">{title}</h4>}
                <div className="text-sm text-gray-700 space-y-2">
                    {children}
                </div>
            </div>
        </div>
        {imageSrc && (
            <div className="mt-4">
                <img src={imageSrc} alt={imageAlt} className="rounded-md max-h-48 w-auto mx-auto opacity-75" 
                     onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/300x150/E0E7FF/1D4ED8?text=Image+Not+Found`; }}/>
            </div>
        )}
    </div>
);

const WelcomeScreen = () => {
    const { navigateToStep } = useContext(AppContext);
    const [expandedTile, setExpandedTile] = useState(null);
    const tiles = [
        { 
            id: 'report', 
            icon: <ListChecks size={36} />, 
            title: "Free OHS Compliance Report", 
            description: "Answer a few questions to get a basic OHS compliance snapshot and personalized recommendations.",
            details: "Our OHS Compliance Report helps you quickly identify key areas of your Occupational Health and Safety system that may need attention. Based on principles from ISO 45001, the OHS Act, and COID Act, this free assessment provides a foundational understanding of your current compliance status. The results can then seamlessly guide you in selecting the right documents through our Wizard or Manual Selection tools."
        },
        { 
            id: 'wizard', 
            icon: <Settings size={36} />, 
            title: "Automated Wizard", 
            description: "Let our smart wizard guide you through selecting the necessary OHS documents based on your business profile.",
            details: "The Automated Wizard simplifies the process of building your OHS system. By answering a series of questions about your business type, size, industry, and specific activities, the wizard intelligently suggests a tailored list of OHS documents. This is ideal for those who want a guided experience and ensure they cover essential requirements."
        },
        { 
            id: 'manual', 
            icon: <Edit size={36} />, 
            title: "Manual Document Selection", 
            description: "Browse and select specific OHS documents from our comprehensive library if you know what you need.",
            details: "If you're familiar with OHS requirements or have a specific list of documents in mind, the Manual Selection path gives you full control. Browse our categorized library of documents, from OHS Policies to Management Review procedures, and pick exactly what you need to supplement or build your OHS management system."
        }
    ];
    return (
        <div className="max-w-4xl mx-auto text-center">
            <ShieldCheck size={64} className="mx-auto text-blue-600 mb-6" />
            <h1 className="text-4xl font-bold text-gray-800 mb-4">Welcome to the OHS System Builder</h1>
            <p className="text-lg text-gray-600 mb-10">
                Develop and customize your comprehensive OHS Management System documents, aligned with ISO 45001 and South African legislation.
                Choose an option below to get started:
            </p>
            <div className="grid md:grid-cols-3 gap-6 mb-10">
                {tiles.map(tile => (
                    <div key={tile.id}>
                        <InfoTile
                            icon={tile.icon}
                            title={tile.title}
                            description={tile.description}
                            onClick={() => setExpandedTile(expandedTile === tile.id ? null : tile.id)}
                            className={expandedTile === tile.id ? 'ring-2 ring-blue-500' : ''}
                        />
                         {expandedTile === tile.id && (
                            <div className="mt-2 p-4 bg-gray-50 rounded-lg shadow text-left">
                                <p className="text-sm text-gray-700">{tile.details}</p>
                                <Button onClick={() => navigateToStep(tile.id)} className="mt-4 w-full" variant="outline">
                                    Start with {tile.title}
                                </Button>
                            </div>
                        )}
                    </div>
                ))}
            </div>
             <InfoCard title="Why OHS Compliance Matters" icon={<AlertTriangle size={24} className="text-yellow-500" />} >
                <p>Ensuring Occupational Health and Safety (OHS) compliance is not just a legal requirement in South Africa; it's crucial for protecting your employees, reducing workplace incidents, improving productivity, and building a responsible business reputation.</p>
                <p>Our tools are designed to help you meet requirements such as the Occupational Health and Safety Act 85 of 1993 and the Compensation for Occupational Injuries and Diseases Act 130 of 1993 (COID Act).</p>
            </InfoCard>
        </div>
    );
};

const OHSComplianceReport = () => {
    const { navigateToStep, reportData, setReportData, setWizardData, setManualSelections, setShowModal } = useContext(AppContext);
    const [currentReportStep, setCurrentReportStep] = useState(1);
    const [localReportData, setLocalReportData] = useState(reportData);
    const questions = [ 
        {
            step: 1, items: [
                { id: 'companyName', label: 'Company Name', type: 'text', required: true },
                { id: 'industry', label: 'Industry Sector', type: 'select', options: [{value: 'construction', label: 'Construction'}, {value: 'manufacturing', label: 'Manufacturing'}, {value: 'office', label: 'Office/Admin'}, {value: 'retail', label: 'Retail'}, {value: 'other', label: 'Other'}], required: true },
                { id: 'numEmployees', label: 'Number of Employees (including directors)', type: 'number', min: 0, required: true, helpText: "This helps determine requirements like OHS Reps (Sec 17, OHS Act)." },
            ]
        },
        {
            step: 2, items: [
                { id: 'hasOHSPolicy', label: 'Do you have a documented OHS Policy?', type: 'radio', options: [{value: 'yes', label: 'Yes'}, {value: 'no', label: 'No'}, {value: 'unsure', label: 'Unsure'}] },
                { id: 'conductRiskAssessments', label: 'Do you regularly conduct and document Hazard Identification and Risk Assessments (HIRAs)?', type: 'radio', options: [{value: 'yes', label: 'Yes'}, {value: 'no', label: 'No'}, {value: 'partially', label: 'Partially'}] },
                { id: 'awareOfLegalReqs', label: 'Are you aware of the specific OHS legal requirements applicable to your operations?', type: 'radio', options: [{value: 'yes', label: 'Yes'}, {value: 'no', label: 'No'}, {value: 'somewhat', label: 'Somewhat'}] },
            ]
        },
        {
            step: 3, items: [
                { id: 'hasOHSReps', label: 'Have you appointed OHS Representatives (if >20 employees, or as per risk assessment)?', type: 'radio', options: [{value: 'yes', label: 'Yes'}, {value: 'no', label: 'No'}, {value: 'na', label: 'N/A (<20 employees and low risk)'}] },
                { id: 'provideOHSTraining', label: 'Do you provide OHS training to your employees?', type: 'radio', options: [{value: 'yes', label: 'Yes'}, {value: 'no', label: 'No'}, {value: 'basic', label: 'Basic Only'}] },
                { id: 'registeredCOID', label: 'Is your company registered with the Compensation Fund (COID Act)?', type: 'radio', options: [{value: 'yes', label: 'Yes'}, {value: 'no', label: 'No'}, {value: 'na', label: 'N/A (e.g., only directors, no employees)'}], helpText: "Generally required if you have employees. Directors who are also shareholders might be exempt if no other employees." },
            ]
        }
    ];
    const totalReportSteps = Math.max(...questions.map(q => q.step));
    const handleChange = (id, value) => setLocalReportData(prev => ({ ...prev, [id]: value }));

    const handleNextReportStep = () => {
        const currentQuestions = questions.find(q => q.step === currentReportStep)?.items || [];
        for (let item of currentQuestions) {
            if (item.required && (!localReportData[item.id] || String(localReportData[item.id]).trim() === '')) {
                 setShowModal({type: 'error', title: 'Missing Information', message: `Please fill in the required field: ${item.label}`});
                 return;
            }
        }
        if (currentReportStep < totalReportSteps) {
            setCurrentReportStep(prev => prev + 1);
        } else {
            setReportData(localReportData);
            let score = 0;
            let recommendations = [];
            if (localReportData.hasOHSPolicy === 'yes') score += 10; else recommendations.push('Develop an OHS Policy.');
            if (localReportData.conductRiskAssessments === 'yes') score += 15; else recommendations.push('Implement regular Hazard Identification & Risk Assessments.');
            if (localReportData.awareOfLegalReqs === 'yes') score += 10; else recommendations.push('Establish a Legal & Other Requirements Register.');
            if (parseInt(localReportData.numEmployees) > 0 && localReportData.registeredCOID !== 'yes' && localReportData.registeredCOID !== 'na') {
                recommendations.push('Ensure COID registration if you have employees.');
            } else if (localReportData.registeredCOID === 'yes') {
                 score += 5;
            }
            setLocalReportData(prev => ({ ...prev, score, recommendations }));
            setCurrentReportStep(prev => prev + 1);
        }
    };
    const handlePrevReportStep = () => currentReportStep > 1 && setCurrentReportStep(prev => prev - 1);
    const proceedWithRecommendations = (target) => { 
        let initialSelections = {};
        if (localReportData.recommendations?.includes('Develop an OHS Policy.')) initialSelections['ohs_policy'] = true;
        if (localReportData.recommendations?.includes('Implement regular Hazard Identification & Risk Assessments.')) initialSelections['hazard_identification'] = true;
        
        if (target === 'wizard') {
            setWizardData(prev => ({ ...prev, companyName: localReportData.companyName, industry: localReportData.industry, numEmployees: localReportData.numEmployees, preSelectedDocs: initialSelections }));
            navigateToStep('wizard');
        } else if (target === 'manual') {
            setManualSelections(initialSelections); // This was missing setManualSelections from context
            navigateToStep('manual');
        }
    };
    const stepNames = ["Company Basics", "Policy & Planning", "Implementation & COID", "Your Report"];
    
    return (
        <div className="max-w-3xl mx-auto p-4 md:p-6 bg-white shadow-xl rounded-lg">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-3xl font-semibold text-gray-800">OHS Compliance Report</h2>
                <Button onClick={() => navigateToStep('welcome')} variant="ghost" iconLeft={<ArrowLeft size={18}/>}>Back to Welcome</Button>
            </div>
            <StepIndicator current={currentReportStep} total={totalReportSteps + 1} stepNames={stepNames} />
            {currentReportStep <= totalReportSteps && (
                <>
                    <h3 className="text-xl font-semibold text-gray-700 mb-4">Step {currentReportStep}: {stepNames[currentReportStep-1]}</h3>
                    {questions.filter(q => q.step === currentReportStep).flatMap(q => q.items).map(item => (
                        item.type === 'radio' ? (
                            <div key={item.id} className="mb-4">
                                <p className="block text-sm font-medium text-gray-700 mb-1">{item.label} {item.required && <span className="text-red-500">*</span>}</p>
                                {item.options.map(opt => (
                                    <label key={opt.value} className="inline-flex items-center mr-4">
                                        <input type="radio" className="form-radio text-blue-600" name={item.id} value={opt.value} checked={localReportData[item.id] === opt.value} onChange={(e) => handleChange(item.id, e.target.value)} />
                                        <span className="ml-2 text-sm text-gray-700">{opt.label}</span>
                                    </label>
                                ))}
                                {item.helpText && <p className="mt-1 text-xs text-gray-500">{item.helpText}</p>}
                            </div>
                        ) : item.type === 'select' ? (
                             <Select key={item.id} {...item} value={localReportData[item.id] || ''} onChange={(e) => handleChange(item.id, e.target.value)} />
                        ) : (
                            <Input key={item.id} {...item} value={localReportData[item.id] || ''} onChange={(e) => handleChange(item.id, e.target.value)} />
                        )
                    ))}
                    <div className="flex justify-between mt-8">
                        <Button onClick={handlePrevReportStep} disabled={currentReportStep === 1} variant="secondary" iconLeft={<ArrowLeft size={18}/>}>Previous</Button>
                        <Button onClick={handleNextReportStep} iconRight={<ChevronRight size={18}/>}>
                            {currentReportStep === totalReportSteps ? 'Generate Report' : 'Next'}
                        </Button>
                    </div>
                    <InfoCard title={`Understanding Step ${currentReportStep}: ${stepNames[currentReportStep-1]}`} icon={<HelpCircle size={20} className="text-blue-500" />} >
                       { currentReportStep === 1 && <p>Basic company information helps us tailor OHS recommendations. Employee numbers, for instance, influence requirements for OHS representatives under Section 17 of the OHS Act.</p> }
                       { currentReportStep === 2 && <p>A documented OHS Policy and regular risk assessments are cornerstones of ISO 45001 and effective OHS management. Knowing your legal duties is paramount.</p> }
                       { currentReportStep === 3 && <p>Appointing OHS representatives, providing training, and ensuring COID Act compliance (if applicable) are critical operational aspects. Companies with no employees (only directors who are shareholders) may not need to register for COID, but this should be verified.</p> }
                    </InfoCard>
                </>
            )}
            {currentReportStep > totalReportSteps && (
                <div className="mt-6">
                    <h3 className="text-2xl font-semibold text-green-600 mb-3 flex items-center"><CheckCircle size={28} className="mr-2"/>Your Basic OHS Compliance Report</h3>
                    <p className="text-gray-700 mb-2"><strong>Company:</strong> {localReportData.companyName}</p>
                    <p className="text-gray-700 mb-4"><strong>Industry:</strong> {localReportData.industry}</p>
                    <div className="bg-gray-100 p-4 rounded-lg mb-4">
                        <h4 className="text-lg font-semibold text-gray-800">Compliance Score (Illustrative):</h4>
                        <p className="text-3xl font-bold text-blue-600">{localReportData.score || 0} / 35</p> {/* Max score updated */}
                    </div>
                    <div className="mb-6">
                        <h4 className="text-lg font-semibold text-gray-800 mb-2">Key Recommendations:</h4>
                        {localReportData.recommendations && localReportData.recommendations.length > 0 ? (
                            <ul className="list-disc list-inside text-gray-700 space-y-1">
                                {localReportData.recommendations.map((rec, i) => <li key={i}>{rec}</li>)}
                            </ul>
                        ) : (
                            <p className="text-green-600">No immediate critical recommendations based on this basic assessment. Consider a comprehensive review.</p>
                        )}
                    </div>
                    <p className="text-sm text-gray-500 mb-6"><strong>Disclaimer:</strong> This is a basic, illustrative report based on the information you provided. It is not a substitute for a comprehensive OHS audit or legal advice. For a full assessment, consider our premium services or consult with an OHS professional.</p>
                    <div className="flex flex-col sm:flex-row gap-4">
                        <Button onClick={() => proceedWithRecommendations('wizard')} className="w-full sm:w-auto" iconLeft={<Settings size={18}/>}>Proceed to Wizard</Button>
                        <Button onClick={() => proceedWithRecommendations('manual')} className="w-full sm:w-auto" variant="outline" iconLeft={<Edit size={18}/>}>Go to Manual Selection</Button>
                    </div>
                     <InfoCard title="Next Steps & Further Action" icon={<ExternalLink size={20} className="text-blue-500" />} >
                        <p>Your free report provides a starting point. To build a robust OHS system:</p>
                        <ul className="list-disc list-inside ml-4 mt-2">
                            <li>Use the "Proceed to Wizard" option to get a tailored list of documents based on your report.</li>
                            <li>Opt for "Manual Selection" if you prefer to choose documents yourself.</li>
                            <li>Consider a comprehensive OHS audit for a detailed gap analysis.</li>
                            <li>Ensure all legal appointments are correctly made and documented.</li>
                        </ul>
                    </InfoCard>
                </div>
            )}
        </div>
    );
};

const AutomatedWizard = () => {
    const { navigateToStep, wizardData, setWizardData, allDocuments, setCart, companyInfo, setCompanyInfo, personInfo, setPersonInfo, getDocumentContentTemplate } = useContext(AppContext);
    const [currentWizardStep, setCurrentWizardStep] = useState(1);
    const [localWizardData, setLocalWizardData] = useState(wizardData);
    const [localCompanyInfo, setLocalCompanyInfo] = useState(companyInfo);
    const [localPersonInfo, setLocalPersonInfo] = useState(personInfo);
    const [suggestedDocs, setSuggestedDocs] = useState({});
    const wizardStepsConfig = [ 
        { name: "Business Profile", step: 1 },
        { name: "Operational Details", step: 2 },
        { name: "Select Documents", step: 3 },
        { name: "Company Information", step: 4 },
        { name: "Person Compiling", step: 5 },
    ];
    const totalWizardSteps = wizardStepsConfig.length;
    useEffect(() => { 
        if (wizardData.companyName && !localCompanyInfo.name) {
            setLocalCompanyInfo(prev => ({...prev, name: wizardData.companyName}));
        }
        if (wizardData.industry && !localWizardData.industry) {
             setLocalWizardData(prev => ({...prev, industry: wizardData.industry}));
        }
         if (wizardData.numEmployees && !localWizardData.numEmployees) {
             setLocalWizardData(prev => ({...prev, numEmployees: wizardData.numEmployees}));
        }
        if (wizardData.preSelectedDocs) {
            setSuggestedDocs(prev => ({...prev, ...wizardData.preSelectedDocs}));
            setWizardData(prev => {
                const { preSelectedDocs, ...rest } = prev;
                return rest;
            });
        }
    }, [wizardData, localCompanyInfo.name, localWizardData.industry, localWizardData.numEmployees, setWizardData]);
    const handleChange = (field, value, target = 'wizard') => { 
        if (target === 'wizard') setLocalWizardData(prev => ({ ...prev, [field]: value }));
        if (target === 'company') setLocalCompanyInfo(prev => ({ ...prev, [field]: value }));
        if (target === 'person') setLocalPersonInfo(prev => ({ ...prev, [field]: value }));
    };
    const handleDocToggle = (docId) => setSuggestedDocs(prev => ({ ...prev, [docId]: !prev[docId] }));
    const generateSuggestions = () => { 
        let newSuggestions = { ...suggestedDocs };
        newSuggestions['ohs_policy'] = newSuggestions['ohs_policy'] ?? true;
        newSuggestions['hazard_identification'] = newSuggestions['hazard_identification'] ?? true;

        if (localWizardData.industry === 'construction') {
            newSuggestions['emergency_preparedness'] = newSuggestions['emergency_preparedness'] ?? true;
        }
        if (parseInt(localWizardData.numEmployees) > 5) {
            newSuggestions['training_procedure'] = newSuggestions['training_procedure'] ?? true;
            newSuggestions['roles_responsibilities'] = newSuggestions['roles_responsibilities'] ?? true;
        }
        if (localWizardData.orgAge === 'mature') { 
             newSuggestions['management_review'] = newSuggestions['management_review'] ?? true;
             newSuggestions['internal_audit'] = newSuggestions['internal_audit'] ?? true;
        }
        setSuggestedDocs(newSuggestions);
    };
    const handleNextWizardStep = () => { 
        if (currentWizardStep === 2) { 
            generateSuggestions();
        }
        if (currentWizardStep < totalWizardSteps) {
            setCurrentWizardStep(prev => prev + 1);
        } else { 
            setWizardData(localWizardData);
            setCompanyInfo(localCompanyInfo);
            setPersonInfo(localPersonInfo);
            const selectedDocIds = Object.keys(suggestedDocs).filter(id => suggestedDocs[id]);
            const docsForCart = selectedDocIds.map(id => {
                const docDetails = Object.values(allDocuments).flat().find(d => d.id === id);
                return { ...docDetails, content: getDocumentContentTemplate(id) }; 
            });
            setCart(docsForCart);
            navigateToStep('previewDocs');
        }
    };
    const handlePrevWizardStep = () => currentWizardStep > 1 && setCurrentWizardStep(prev => prev - 1);
    const renderWizardStep = () => { 
        switch (currentWizardStep) {
            case 1: 
                return (
                    <>
                        <Select label="Primary Industry" id="industry" value={localWizardData.industry || ''} onChange={(e) => handleChange('industry', e.target.value)}
                            options={[{value: 'construction', label: 'Construction'}, {value: 'manufacturing', label: 'Manufacturing'}, {value: 'office', label: 'Office/Admin'}, {value: 'retail', label: 'Retail'}, {value: 'mining', label: 'Mining'}, {value: 'agriculture', label: 'Agriculture'}, {value: 'other', label: 'Other'}]} required />
                        <Input label="Number of Employees" id="numEmployees" type="number" value={localWizardData.numEmployees || ''} onChange={(e) => handleChange('numEmployees', e.target.value)} placeholder="e.g., 15" required 
                            helpText="Include all personnel, including management and directors if they are employees."/>
                        <Select label="Business Age" id="orgAge" value={localWizardData.orgAge || ''} onChange={(e) => handleChange('orgAge', e.target.value)}
                            options={[
                                {value: 'new', label: 'New Venture (Startup, less than 1 year)'},
                                {value: 'established', label: 'Established Business (1-5 years)'},
                                {value: 'mature', label: 'Mature Organization (More than 5 years)'}
                            ]} required />
                        <InfoCard title="Why these details?" icon={<Briefcase size={20}/>} imageSrc="https://placehold.co/300x150/E0F2FE/0EA5E9?text=Business+Insights">
                           <p>Your industry, employee count, and business age help us suggest relevant OHS documents...</p>
                        </InfoCard>
                    </>
                );
            case 2: 
                return (
                    <>
                        <Checkbox label="Do you handle hazardous substances?" id="hazardousSubstances" checked={localWizardData.hazardousSubstances || false} onChange={(e) => handleChange('hazardousSubstances', e.target.checked)} />
                        <Checkbox label="Do your employees work at heights?" id="workAtHeight" checked={localWizardData.workAtHeight || false} onChange={(e) => handleChange('workAtHeight', e.target.checked)} />
                        <Checkbox label="Do you use heavy machinery or equipment?" id="heavyMachinery" checked={localWizardData.heavyMachinery || false} onChange={(e) => handleChange('heavyMachinery', e.target.checked)} />
                        <Checkbox label="Are there public access areas at your workplace?" id="publicAccess" checked={localWizardData.publicAccess || false} onChange={(e) => handleChange('publicAccess', e.target.checked)} />
                         <InfoCard title="Operational Risks" icon={<AlertTriangle size={20}/>} imageSrc="https://placehold.co/300x150/FEF9C3/FACC15?text=Risk+Factors">
                            <p>Understanding your operational activities allows the wizard to pinpoint specific procedures...</p>
                        </InfoCard>
                    </>
                );
            case 3: 
                 return (
                    <div>
                        <p className="text-gray-700 mb-4">Based on your answers, we've suggested some documents. You can add or remove documents as needed.</p>
                        {Object.entries(allDocuments).map(([category, docs]) => (
                            <div key={category} className="mb-4 p-4 border rounded-lg">
                                <h4 className="text-lg font-semibold text-gray-700 mb-2 capitalize">{docs[0]?.category || category}</h4>
                                {docs.map(doc => (
                                    <Checkbox
                                        key={doc.id}
                                        id={doc.id}
                                        label={`${doc.name} (R${doc.price})`}
                                        checked={suggestedDocs[doc.id] || false}
                                        onChange={() => handleDocToggle(doc.id)}
                                    />
                                ))}
                            </div>
                        ))}
                         <InfoCard title="Document Selection Guidance" icon={<FilePlus size={20}/>} imageSrc="https://placehold.co/300x150/E0E7FF/6366F1?text=Your+System">
                           <p>This list is a starting point. Review each document category...</p>
                        </InfoCard>
                    </div>
                );
            case 4: 
                return (
                    <>
                        <Input label="Company Legal Name" id="companyName" value={localCompanyInfo.name || wizardData.companyName || ''} onChange={(e) => handleChange('name', e.target.value, 'company')} required />
                        <Input label="Trading As (if different)" id="tradingName" value={localCompanyInfo.tradingName || ''} onChange={(e) => handleChange('tradingName', e.target.value, 'company')} />
                        <Input label="Company Registration Number" id="regNumber" value={localCompanyInfo.regNumber || ''} onChange={(e) => handleChange('regNumber', e.target.value, 'company')} />
                        <Input label="Physical Address" id="address" value={localCompanyInfo.address || ''} onChange={(e) => handleChange('address', e.target.value, 'company')} required />
                        <Input label="Contact Number" id="phone" type="tel" value={localCompanyInfo.phone || ''} onChange={(e) => handleChange('phone', e.target.value, 'company')} />
                        <Input label="Email Address" id="email" type="email" value={localCompanyInfo.email || ''} onChange={(e) => handleChange('email', e.target.value, 'company')} />
                        <Input label="COID Registration Number (if applicable)" id="coidNumber" value={localCompanyInfo.coidNumber || ''} onChange={(e) => handleChange('coidNumber', e.target.value, 'company')} helpText="Required by the Compensation for Occupational Injuries and Diseases Act if you have employees." />
                         <InfoCard title="Accurate Company Details" icon={<Building size={20}/>} imageSrc="https://placehold.co/300x150/DBEAFE/3B82F6?text=Official+Info">
                            <p>Ensure all company information is accurate as it will be used to populate your OHS documents...</p>
                        </InfoCard>
                    </>
                );
            case 5: 
                return (
                    <>
                        <Input label="Full Name" id="fullName" value={localPersonInfo.fullName || ''} onChange={(e) => handleChange('fullName', e.target.value, 'person')} required />
                        <Input label="Designation / Role" id="designation" value={localPersonInfo.designation || ''} onChange={(e) => handleChange('designation', e.target.value, 'person')} required />
                        <Input label="Email Address" id="compilerEmail" type="email" value={localPersonInfo.email || ''} onChange={(e) => handleChange('email', e.target.value, 'person')} required />
                        <Input label="Contact Number" id="compilerPhone" type="tel" value={localPersonInfo.phone || ''} onChange={(e) => handleChange('phone', e.target.value, 'person')} />
                        <InfoCard title="Compiler Information" icon={<Users size={20}/>} imageSrc="https://placehold.co/300x150/E0F2FE/0EA5E9?text=Contact+Person">
                            <p>The details of the person compiling the OHS system are important for record-keeping...</p>
                        </InfoCard>
                    </>
                );
            default: return <p>Unknown wizard step.</p>;
        }
    };
    return ( 
        <div className="max-w-3xl mx-auto p-4 md:p-6 bg-white shadow-xl rounded-lg">
            <div className="flex justify-between items-center mb-6">
                 <h2 className="text-3xl font-semibold text-gray-800">Automated OHS Wizard</h2>
                 <Button onClick={() => navigateToStep('welcome')} variant="ghost" iconLeft={<ArrowLeft size={18}/>}>Back to Welcome</Button>
            </div>
            <StepIndicator current={currentWizardStep} total={totalWizardSteps} stepNames={wizardStepsConfig.map(s => s.name)} />
            <div className="mt-6">{renderWizardStep()}</div>
            <div className="flex justify-between items-center mt-10 pt-6 border-t">
                <Button onClick={handlePrevWizardStep} disabled={currentWizardStep === 1} variant="secondary" iconLeft={<ArrowLeft size={18}/>}>Previous</Button>
                <Button onClick={handleNextWizardStep} iconRight={<ChevronRight size={18}/>}>
                    {currentWizardStep === totalWizardSteps ? 'Finalize Selections & Proceed' : 'Next'}
                </Button>
            </div>
        </div>
    );
};

const ManualDocumentSelection = () => {
    const { navigateToStep, manualSelections, setManualSelections, allDocuments, setCart, setCompanyInfo, setPersonInfo, getDocumentContentTemplate, wizardData, setWizardData, setShowModal } = useContext(AppContext);
    const [expandedCategory, setExpandedCategory] = useState(null);
    const [localSelections, setLocalSelections] = useState(manualSelections);
    useEffect(() => { 
        if (wizardData.preSelectedDocs) {
            setLocalSelections(prev => ({...prev, ...wizardData.preSelectedDocs}));
            setWizardData(prev => { 
                const { preSelectedDocs, ...rest } = prev;
                return rest;
            });
        }
    }, [wizardData, setWizardData]); 
    const toggleCategory = (category) => setExpandedCategory(expandedCategory === category ? null : category);
    const handleDocToggle = (docId) => setLocalSelections(prev => ({ ...prev, [docId]: !prev[docId] }));
    const handleSelectAll = (categoryDocs) => { 
        const newSelections = { ...localSelections };
        categoryDocs.forEach(doc => newSelections[doc.id] = true);
        setLocalSelections(newSelections);
    };
    const handleDeselectAll = (categoryDocs) => { 
         const newSelections = { ...localSelections };
        categoryDocs.forEach(doc => newSelections[doc.id] = false);
        setLocalSelections(newSelections);
    };
    const countSelectedInCategory = (docs) => docs.filter(doc => localSelections[doc.id]).length;
    const proceedToCompanyDetails = () => {
        setManualSelections(localSelections);
        const selectedDocIds = Object.keys(localSelections).filter(id => localSelections[id]);
        if (selectedDocIds.length === 0) {
            setShowModal({type: 'error', title: 'No Documents Selected', message: 'Please select at least one document to proceed.'});
            return;
        }
        const docsForCart = selectedDocIds.map(id => {
            const docDetails = Object.values(allDocuments).flat().find(d => d.id === id);
             return { ...docDetails, content: getDocumentContentTemplate(id) };
        });
        setCart(docsForCart);
        setCompanyInfo(wizardData.companyName ? {name: wizardData.companyName} : {});
        setPersonInfo({});
        navigateToStep('companyInfo');
    };
    
    return (
        <div className="max-w-4xl mx-auto p-4 md:p-6 bg-white shadow-xl rounded-lg">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-3xl font-semibold text-gray-800">Manual Document Selection</h2>
                <Button onClick={() => navigateToStep('welcome')} variant="ghost" iconLeft={<ArrowLeft size={18}/>}>Back to Welcome</Button>
            </div>
            <p className="text-gray-600 mb-6">Browse the categories below and select the specific documents you need. Click on a category to expand it.</p>
            {Object.entries(allDocuments).map(([key, docsInCategory]) => (
                <div key={key} className="mb-3 border border-gray-200 rounded-lg overflow-hidden">
                    <button
                        onClick={() => toggleCategory(key)}
                        className="w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 focus:outline-none"
                    >
                        <span className="text-lg font-medium text-gray-700 text-left">{docsInCategory[0]?.category || key} ({countSelectedInCategory(docsInCategory)} selected)</span>
                        {expandedCategory === key ? <ChevronDown size={20} /> : <ChevronRight size={20} />}
                    </button>
                    {expandedCategory === key && (
                        <div className="p-4 border-t border-gray-200">
                            <div className="flex justify-end space-x-2 mb-3">
                                <Button onClick={() => handleSelectAll(docsInCategory)} size="sm" variant="outline">Select All</Button>
                                <Button onClick={() => handleDeselectAll(docsInCategory)} size="sm" variant="ghost">Deselect All</Button>
                            </div>
                            {docsInCategory.map(doc => (
                                <Checkbox
                                    key={doc.id}
                                    id={`manual-${doc.id}`}
                                    label={`${doc.name} (R${doc.price})`}
                                    checked={localSelections[doc.id] || false}
                                    onChange={() => handleDocToggle(doc.id)}
                                />
                            ))}
                        </div>
                    )}
                </div>
            ))}
            <InfoCard title="Building Your OHS System Manually" icon={<FileText size={20}/>} imageSrc="https://placehold.co/300x150/F3E8FF/A855F7?text=Custom+Build">
                <p>Manual selection is great if you have specific needs. Ensure you cover core ISO 45001 elements...</p>
            </InfoCard>
            <div className="mt-8 flex justify-end">
                <Button onClick={proceedToCompanyDetails} iconRight={<ChevronRight size={18}/>} disabled={Object.values(localSelections).every(v => !v)}>
                    Proceed to Company Details
                </Button>
            </div>
        </div>
    );
};

const CompanyInformationStep = () => {
    const { navigateToStep, companyInfo, setCompanyInfo, personInfo, setPersonInfo, wizardData, setShowModal, manualSelections } = useContext(AppContext);
    const [localCompanyInfo, setLocalCompanyInfo] = useState(companyInfo);
    useEffect(() => { 
        if (wizardData.companyName && !localCompanyInfo.name) {
            setLocalCompanyInfo(prev => ({...prev, name: wizardData.companyName}));
        }
    }, [wizardData, localCompanyInfo.name]);
    const handleChange = (field, value) => setLocalCompanyInfo(prev => ({ ...prev, [field]: value }));
    const handleNext = () => {
        if (!localCompanyInfo.name || !localCompanyInfo.address) {
            setShowModal({type: 'error', title: 'Missing Information', message: 'Company Name and Physical Address are required.'});
            return;
        }
        setCompanyInfo(localCompanyInfo);
        setPersonInfo({}); 
        navigateToStep('personInfo');
    };
    const handleBack = () => {
        const hasManualSelections = Object.values(manualSelections).some(sel => sel === true);
        if (hasManualSelections) {
             navigateToStep('manual');
        } else { 
             navigateToStep('wizard'); 
        }
    };
    
    return (
        <div className="max-w-3xl mx-auto p-4 md:p-6 bg-white shadow-xl rounded-lg">
            <h2 className="text-3xl font-semibold text-gray-800 mb-6">Step: Enter Company Information</h2>
            <StepIndicator current={2} total={4} stepNames={["Select Docs", "Company Info", "Person Info", "Preview"]} /> 
            
            <Input label="Company Legal Name" id="companyName" value={localCompanyInfo.name || ''} onChange={(e) => handleChange('name', e.target.value)} required />
            <Input label="Trading As (if different)" id="tradingName" value={localCompanyInfo.tradingName || ''} onChange={(e) => handleChange('tradingName', e.target.value)} />
            <Input label="Company Registration Number" id="regNumber" value={localCompanyInfo.regNumber || ''} onChange={(e) => handleChange('regNumber', e.target.value)} />
            <Input label="Physical Address" id="address" value={localCompanyInfo.address || ''} onChange={(e) => handleChange('address', e.target.value)} required />
            <Input label="Contact Number" id="phone" type="tel" value={localCompanyInfo.phone || ''} onChange={(e) => handleChange('phone', e.target.value)} />
            <Input label="Email Address" id="email" type="email" value={localCompanyInfo.email || ''} onChange={(e) => handleChange('email', e.target.value)} />
            <Input label="COID Registration Number (if applicable)" id="coidNumber" value={localCompanyInfo.coidNumber || ''} onChange={(e) => handleChange('coidNumber', e.target.value)} helpText="Required by COID Act if you have employees." />
            
            <InfoCard title="Accurate Company Details" icon={<Building size={20}/>} imageSrc="https://placehold.co/300x150/DBEAFE/3B82F6?text=Official+Info">
                <p>Ensure all company information is accurate as it will be used to populate your OHS documents...</p>
            </InfoCard>

            <div className="flex justify-between mt-8">
                <Button onClick={handleBack} variant="secondary" iconLeft={<ArrowLeft size={18}/>}>Back</Button>
                <Button onClick={handleNext} iconRight={<ChevronRight size={18}/>}>Next: Person Compiling</Button>
            </div>
        </div>
    );
};

const PersonCompilingStep = () => {
    const { navigateToStep, personInfo, setPersonInfo, cart, setShowModal } = useContext(AppContext);
    const [localPersonInfo, setLocalPersonInfo] = useState(personInfo);
    const handleChange = (field, value) => setLocalPersonInfo(prev => ({ ...prev, [field]: value }));
    const handleNext = () => {
        if (!localPersonInfo.fullName || !localPersonInfo.designation || !localPersonInfo.email) {
            setShowModal({type: 'error', title: 'Missing Information', message: 'Full Name, Designation, and Email of the compiler are required.'});
            return;
        }
        setPersonInfo(localPersonInfo);
        if (cart.length === 0) {
            setShowModal({type: 'error', title: 'No Documents', message: 'Error: No documents selected. Please go back and select documents.'});
            navigateToStep('manual');
            return;
        }
        navigateToStep('previewDocs');
    };
    const handleBack = () => navigateToStep('companyInfo');
    
    return (
        <div className="max-w-3xl mx-auto p-4 md:p-6 bg-white shadow-xl rounded-lg">
            <h2 className="text-3xl font-semibold text-gray-800 mb-6">Step: Your Details (Person Compiling)</h2>
             <StepIndicator current={3} total={4} stepNames={["Select Docs", "Company Info", "Person Info", "Preview"]} />

            <Input label="Full Name" id="fullName" value={localPersonInfo.fullName || ''} onChange={(e) => handleChange('fullName', e.target.value)} required />
            <Input label="Designation / Role" id="designation" value={localPersonInfo.designation || ''} onChange={(e) => handleChange('designation', e.target.value)} required />
            <Input label="Email Address" id="compilerEmail" type="email" value={localPersonInfo.email || ''} onChange={(e) => handleChange('email', e.target.value)} required />
            <Input label="Contact Number" id="compilerPhone" type="tel" value={localPersonInfo.phone || ''} onChange={(e) => handleChange('phone', e.target.value)} />
            
            <InfoCard title="Compiler Information" icon={<Users size={20}/>} imageSrc="https://placehold.co/300x150/E0F2FE/0EA5E9?text=Contact+Person">
                <p>The details of the person compiling the OHS system are important for record-keeping...</p>
            </InfoCard>

            <div className="flex justify-between mt-8">
                <Button onClick={handleBack} variant="secondary" iconLeft={<ArrowLeft size={18}/>}>Back</Button>
                <Button onClick={handleNext} iconRight={<ChevronRight size={18}/>}>Next: Preview Documents</Button>
            </div>
        </div>
    );
};

const DocumentPreviewScreen = () => {
    const { navigateToStep, cart, setCart, getDocumentContentTemplate, companyInfo, personInfo, wizardData, manualSelections } = useContext(AppContext);
    const [editingDocId, setEditingDocId] = useState(null);
    const [currentContent, setCurrentContent] = useState('');

    useEffect(() => { 
        const updatedCart = cart.map(doc => {
            const isDefaultTemplate = doc.content && doc.content.includes("[Company Name]") && doc.content.includes("[Compiler Name]");
            if (isDefaultTemplate || !doc.content) {
                return { ...doc, content: getDocumentContentTemplate(doc.id) };
            }
            return doc;
        });
        if (JSON.stringify(updatedCart) !== JSON.stringify(cart)) {
            setCart(updatedCart);
        }
    }, [companyInfo, personInfo, getDocumentContentTemplate, setCart, cart]);

    const handleEdit = (doc) => { 
        setEditingDocId(doc.id);
        setCurrentContent(doc.content || getDocumentContentTemplate(doc.id));
    };
    const handleSaveEdit = () => { 
        setCart(prevCart => prevCart.map(doc =>
            doc.id === editingDocId ? { ...doc, content: currentContent, hasBeenEdited: true } : doc
        ));
        setEditingDocId(null);
        setCurrentContent('');
    };
    const handleBack = () => {
        const cameFromWizard = Object.keys(wizardData).length > 0 && (wizardData.industry || wizardData.numEmployees || wizardData.orgAge);
        const cameFromManual = Object.values(manualSelections).some(sel => sel === true);

        if (cameFromWizard) {
             navigateToStep('wizard'); 
        } else if (cameFromManual) {
             navigateToStep('personInfo'); 
        } else {
            navigateToStep('welcome'); 
        }
    };

    if (editingDocId) {
        const doc = cart.find(d => d.id === editingDocId);
        return (
            <div className="max-w-4xl mx-auto p-6 bg-white shadow-xl rounded-lg">
                <h2 className="text-2xl font-semibold mb-4">Editing: {doc.name}</h2>
                <ReactQuill 
                    theme="snow" 
                    value={currentContent} 
                    onChange={setCurrentContent} 
                    modules={{ toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],        
                        [{'list': 'ordered'}, {'list': 'bullet'}],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],          
                        [{ 'align': [] }],
                        ['link', 'clean']                         
                    ]}} 
                    className="h-[500px] mb-16" 
                    placeholder="Start typing your document content here..."
                />
                <div className="flex justify-end space-x-3 mt-6">
                    <Button onClick={() => setEditingDocId(null)} variant="secondary">Cancel</Button>
                    <Button onClick={handleSaveEdit}>Save Changes to Document</Button>
                </div>
            </div>
        );
    }
    
    const cameFromWizard = Object.keys(wizardData).length > 0 && (wizardData.industry || wizardData.numEmployees || wizardData.orgAge);
    const previewStepNumber = cameFromWizard ? 6 : 4; 
    const totalPreviewFlowSteps = cameFromWizard ? 7 : 5;
    const previewStepNames = cameFromWizard ? 
        ["Profile", "Ops", "Docs", "Company", "Compiler", "Preview", "Checkout"] :
        ["Select Docs", "Company Info", "Person Info", "Preview", "Checkout"];

    const noDocumentsView = (
        <p className="text-center text-gray-500 py-8">No documents selected. Please go back and select documents.</p>
    );

    const documentsListView = (
        <div className="space-y-4">
            {cart.map(doc => (
                <div key={doc.id} className="p-4 border rounded-lg shadow-sm bg-gray-50">
                    <div className="flex justify-between items-center">
                        <h3 className="text-lg font-medium text-gray-700">{doc.name}</h3>
                        <Button onClick={() => handleEdit(doc)} variant="outline" size="sm" iconLeft={<Edit3 size={16}/>}>Edit Document</Button>
                    </div>
                    {doc.hasBeenEdited && <p className="text-xs text-green-600 mt-1">You have made changes to this document.</p>}
                    <div className="mt-2 p-3 bg-white border rounded max-h-40 overflow-y-auto text-xs" dangerouslySetInnerHTML={{ __html: doc.content?.substring(0, 300) + (doc.content?.length > 300 ? '...' : '') }} />
                </div>
            ))}
        </div>
    );

    return (
        <div className="max-w-4xl mx-auto p-4 md:p-6 bg-white shadow-xl rounded-lg">
            <h2 className="text-3xl font-semibold text-gray-800 mb-6">Step: Preview & Edit Your Documents</h2>
            <StepIndicator current={previewStepNumber} total={totalPreviewFlowSteps} stepNames={previewStepNames} />
            <p className="text-gray-600 mb-6">Review the documents selected. You can edit the content of each document. All information provided earlier (Company Name, Compiler details etc.) has been merged into these templates.</p>
            
            {cart.length === 0 ? noDocumentsView : documentsListView}
            
            <InfoCard title="Final Review Stage" icon={<Eye size={20}/>} imageSrc="https://placehold.co/300x150/E0F2FE/0EA5E9?text=Proofread+Now">
                <p>This is your opportunity to ensure all documents are tailored to your specific business needs. Check for:</p>
                <ul className="list-disc list-inside ml-4 mt-2 text-sm">
                    <li>Correct company name, addresses, and contact details.</li>
                    <li>Accurate roles and responsibilities mentioned.</li>
                    <li>Specific procedures that match your operations.</li>
                    <li>Any site-specific information that needs to be included.</li>
                </ul>
                <p className="mt-2">Once you're satisfied, proceed to finalize and checkout.</p>
            </InfoCard>

            <div className="flex justify-between mt-10 pt-6 border-t">
                <Button onClick={handleBack} variant="secondary" iconLeft={<ArrowLeft size={18}/>}>Back</Button>
                <Button onClick={() => navigateToStep('cart')} disabled={cart.length === 0} iconRight={<ShoppingCart size={18}/>}>Finalize & Proceed to Cart</Button>
            </div>
        </div>
    );
};

const AuthModal = ({ mode = 'login', onSuccess, onSwitchMode, onClose }) => { 
    const { setIsLoading, setShowModal } = useContext(AppContext);
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setIsLoading(true);
        try {
            if (mode === 'register') {
                await createUserWithEmailAndPassword(auth, email, password);
            } else {
                await signInWithEmailAndPassword(auth, email, password);
            }
            setIsLoading(false);
            setShowModal(null); 
            if(onSuccess) onSuccess();
        } catch (err) {
            setError(err.message);
            setIsLoading(false);
        }
    };
    return (
         <Modal title={mode === 'login' ? "Login" : "Register"} onClose={onClose}>
            <form onSubmit={handleSubmit} className="space-y-4">
                <Input label="Email" id="auth-email" type="email" value={email} onChange={e => setEmail(e.target.value)} required />
                <Input label="Password" id="auth-password" type="password" value={password} onChange={e => setPassword(e.target.value)} required />
                {error && <p className="text-sm text-red-500">{error}</p>}
                <Button type="submit" className="w-full" disabled={isLoading}>
                    {isLoading ? (mode === 'login' ? 'Logging in...' : 'Registering...') : (mode === 'login' ? 'Login' : 'Create Account')}
                </Button>
            </form>
            <p className="mt-4 text-sm text-center">
                {mode === 'login' ? "Don't have an account? " : "Already have an account? "}
                <button onClick={onSwitchMode} className="font-medium text-blue-600 hover:text-blue-500">
                    {mode === 'login' ? 'Register here' : 'Login here'}
                </button>
            </p>
        </Modal>
    );
};

const CartScreen = () => {
    const { navigateToStep, cart, setCart, user, setShowModal, companyInfo, invoiceDetails, setInvoiceDetails, wizardData, manualSelections } = useContext(AppContext);
    const total = cart.reduce((sum, item) => sum + item.price, 0);
    const removeFromCart = (docId) => setCart(prev => prev.filter(item => item.id !== docId));
    const handleProceedToCheckout = () => {
        if (cart.length === 0) {
            setShowModal({type: 'error', title: 'Empty Cart', message: 'Your cart is empty. Please add documents before proceeding.'});
            return;
        }
        const refNumber = `OHS-${Date.now().toString().slice(-6)}`;
        setInvoiceDetails({
            reference: refNumber,
            date: new Date().toLocaleDateString(),
            items: cart.map(item => ({ name: item.name, price: item.price })),
            total: total,
            companyName: companyInfo?.name || "Valued Customer",
        });
        navigateToStep('checkout');
    };
    
    const cameFromWizard = Object.keys(wizardData).length > 0 && (wizardData.industry || wizardData.numEmployees || wizardData.orgAge);
    const cartStepNumber = cameFromWizard ? 7 : 5; 
    const totalCartFlowSteps = cameFromWizard ? 8 : 6;
    const cartStepNames = cameFromWizard ? 
        ["Profile", "Ops", "Docs", "Company", "Compiler", "Preview", "Cart", "Checkout"] :
        ["Select Docs", "Company Info", "Person Info", "Preview", "Cart", "Checkout"];

    const emptyCartView = (
        <div className="text-center py-10">
            <ShoppingCart size={48} className="mx-auto text-gray-400 mb-4" />
            <p className="text-gray-600 text-lg">Your cart is currently empty.</p>
            <Button onClick={() => navigateToStep('welcome')} className="mt-6" variant='outline'>Browse Documents</Button>
        </div>
    );

    const populatedCartView = (
        <>
            <div className="space-y-4 mb-6">
                {cart.map(item => (
                    <div key={item.id} className="flex justify-between items-center p-4 border rounded-lg bg-gray-50 shadow-sm">
                        <div>
                            <h3 className="font-medium text-gray-700">{item.name}</h3>
                            <p className="text-sm text-gray-500">{item.category}</p>
                        </div>
                        <div className="flex items-center space-x-4">
                            <p className="font-semibold text-gray-800">R{item.price.toFixed(2)}</p>
                            <Button onClick={() => removeFromCart(item.id)} variant="ghost" size="sm" className="text-red-500 hover:text-red-700 p-2"> {/* Adjusted padding for small button */}
                                <Trash2 size={16} />
                            </Button>
                        </div>
                    </div>
                ))}
            </div>
            <div className="py-4 border-t">
                <div className="flex justify-between items-center text-xl font-semibold mb-4">
                    <span>Total:</span>
                    <span>R{total.toFixed(2)}</span>
                </div>
                <Input id="voucher" label="Voucher Code (Optional)" placeholder="Enter voucher code" />
                <Button onClick={handleProceedToCheckout} className="w-full mt-4" iconRight={<CreditCard size={18}/>}>
                    Proceed to Checkout
                </Button>
            </div>
        </>
    );
    
    return (
        <div className="max-w-3xl mx-auto p-4 md:p-6 bg-white shadow-xl rounded-lg">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-3xl font-semibold text-gray-800">Your OHS System Documents Cart</h2>
                 <Button onClick={() => navigateToStep('previewDocs')} variant="ghost" iconLeft={<ArrowLeft size={18}/>}>Back to Preview</Button>
            </div>
             <StepIndicator current={cartStepNumber} total={totalCartFlowSteps} stepNames={cartStepNames} />
            
            {cart.length === 0 ? emptyCartView : populatedCartView}

            {(!user || user.isAnonymous) && (
                <InfoCard title="Want to save your progress and get benefits?" icon={<UserPlus size={20} className="text-blue-500"/>} className="mt-8">
                    <p>Register for a free account to:</p>
                    <ul className="list-disc list-inside ml-4 mt-2 text-sm">
                        <li>Save your document selections and edits.</li>
                        <li>Access your purchased documents anytime.</li>
                        <li>Receive updates and potential future discounts.</li>
                    </ul>
                    <div className="mt-4">
                        <Button onClick={() => setShowModal({type: 'auth', mode: 'register', onSuccess: () => navigateToStep('cart')})} variant="success" iconLeft={<UserPlus size={18}/>}>
                            Register for Free
                        </Button>
                    </div>
                </InfoCard>
            )}
             <InfoCard title="What Happens Next?" icon={<Printer size={20}/>} imageSrc="https://placehold.co/300x150/E0F2FE/0EA5E9?text=Payment+Process">
                <p>After proceeding to checkout: You'll be taken to a secure payment page (simulated). Upon successful payment, you'll receive an invoice/reference number. Non-registered users: Use this reference to access your documents for 7 days. Registered users: Your documents will be saved to your account.</p>
            </InfoCard>
        </div>
    );
};

const CheckoutScreen = () => {
    const { navigateToStep, cart, invoiceDetails, user, userId, systemId, saveSystemData, setShowModal, getPrivateSpacePath, getPublicSpacePath, wizardData, manualSelections } = useContext(AppContext);
    const [isProcessing, setIsProcessing] = useState(false);
    const total = cart.reduce((sum, item) => sum + item.price, 0);
    const handlePayment = async () => { 
        setIsProcessing(true);
        await new Promise(resolve => setTimeout(resolve, 2000));
        if (user && !user.isAnonymous) {
            let currentSystemId = systemId;
            if (!currentSystemId) { // If no systemId, means user didn't save progress but is registered. Save it now.
                await saveSystemData(); // This should set systemId in context via setSystemId
                // Re-fetch systemId from context as saveSystemData is async and updates context
                // This part is a bit tricky due to state update timing. A better way might be for saveSystemData to return the ID.
                // For now, we assume saveSystemData correctly updates systemId in context before this proceeds.
                // A brief timeout or check might be needed if systemId isn't immediately available.
                // This is a simplified approach.
                // currentSystemId = newSystemIdFromContext; // This line is problematic, systemId from context should be used
            }
            // Use systemId directly from context, assuming saveSystemData updated it if it was null
            if (systemId) { // Check if systemId is now available
                const systemRef = doc(db, getPrivateSpacePath(`systems/${systemId}`));
                try {
                    await updateDoc(systemRef, { status: 'purchased', purchasedAt: serverTimestamp(), invoice: invoiceDetails });
                } catch (error) {
                    setShowModal({type: 'error', title: 'Update Error', message: 'Could not mark your system as purchased. Please contact support.'});
                    setIsProcessing(false); return;
                }
            } else {
                 setShowModal({type: 'error', title: 'Save Issue', message: 'Your system data might not have been fully saved before purchase. Please check your dashboard or contact support.'});
                 // Still proceed to confirmation, but with a warning.
            }
        } else { 
             try {
                const tempAccessRef = collection(db, getPublicSpacePath('tempAccess'));
                await addDoc(tempAccessRef, { 
                    ...invoiceDetails, 
                    purchasedItems: cart.map(item => ({id: item.id, name: item.name, content: item.content, price: item.price})),
                    anonymousUserId: userId, 
                    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) 
                });
            } catch(e) { 
                setShowModal({type: 'error', title: 'Access Error', message: 'Could not save temporary access. Note your reference and contact support.'});
                setIsProcessing(false); return;
            }
        }
        setIsProcessing(false);
        navigateToStep('confirmation');
    };
    if (!invoiceDetails) { 
        return (
            <div className="max-w-xl mx-auto p-6 text-center">
                <AlertTriangle size={48} className="mx-auto text-red-500 mb-4" />
                <p className="text-lg text-gray-700">Error: Invoice details not found. Please return to cart.</p>
                <Button onClick={() => navigateToStep('cart')} className="mt-4">Back to Cart</Button>
            </div>
        );
     }
    
    const cameFromWizard = Object.keys(wizardData).length > 0 && (wizardData.industry || wizardData.numEmployees || wizardData.orgAge);
    const checkoutStepNumber = cameFromWizard ? 8 : 6; 
    const totalCheckoutFlowSteps = cameFromWizard ? 8 : 6; 
    const checkoutStepNames = cameFromWizard ? 
        ["Profile", "Ops", "Docs", "Company", "Compiler", "Preview", "Cart", "Checkout"] :
        ["Select Docs", "Company Info", "Person Info", "Preview", "Cart", "Checkout"];
    
    return (
        <div className="max-w-3xl mx-auto p-4 md:p-6 bg-white shadow-xl rounded-lg">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-3xl font-semibold text-gray-800">Finalize & Checkout</h2>
                <Button onClick={() => navigateToStep('cart')} variant="ghost" iconLeft={<ArrowLeft size={18}/>}>Back to Cart</Button>
            </div>
            <StepIndicator current={checkoutStepNumber} total={totalCheckoutFlowSteps} stepNames={checkoutStepNames} />
            <div className="grid md:grid-cols-2 gap-8">
                <div className="bg-gray-50 p-6 rounded-lg">
                    <h3 className="text-xl font-semibold mb-4">Order Summary</h3>
                    <p className="text-sm text-gray-600 mb-1"><strong>Invoice Ref:</strong> {invoiceDetails.reference}</p>
                    <p className="text-sm text-gray-600 mb-3"><strong>Date:</strong> {invoiceDetails.date}</p>
                    <ul className="space-y-2 mb-4">
                        {invoiceDetails.items.map((item, i) => (
                            <li key={i} className="flex justify-between text-sm">
                                <span>{item.name}</span>
                                <span className="font-medium">R{item.price.toFixed(2)}</span>
                            </li>
                        ))}
                    </ul>
                    <div className="border-t pt-3 mt-3 flex justify-between text-lg font-semibold">
                        <span>Total Due:</span>
                        <span>R{invoiceDetails.total.toFixed(2)}</span>
                    </div>
                </div>
                <div className="p-6 rounded-lg border">
                    <h3 className="text-xl font-semibold mb-4">Payment Method</h3>
                    <div className="mb-4">
                        <p className="text-gray-700">This is a simulated payment gateway.</p>
                        <p className="text-sm text-gray-500">No real payment will be processed.</p>
                    </div>
                    <Input label="Cardholder Name" id="cardName" placeholder="John Doe" />
                    <Input label="Card Number" id="cardNumber" placeholder="•••• •••• •••• ••••" />
                    <div className="grid grid-cols-2 gap-4">
                        <Input label="Expiry Date" id="expiry" placeholder="MM/YY" />
                        <Input label="CVV" id="cvv" placeholder="•••" />
                    </div>
                    <Button onClick={handlePayment} className="w-full mt-6" disabled={isProcessing} iconLeft={isProcessing ? <RotateCcw className="animate-spin" size={18}/> : <Check size={18}/>}>
                        {isProcessing ? 'Processing Payment...' : `Pay R${total.toFixed(2)} Securely`}
                    </Button>
                </div>
            </div>
             <InfoCard title="Secure Checkout & Document Access" icon={<ShieldCheck size={20}/>} imageSrc="https://placehold.co/300x150/DCFCE7/16A34A?text=Payment+Secured">
                <p>Your payment information is handled securely (this is a simulation). After successful payment: You will receive a confirmation. Non-registered users: Use the reference number to access documents for 7 days. Registered users: Documents are saved to your account.</p>
            </InfoCard>
        </div>
    );
};

const ConfirmationScreen = () => {
    const { navigateToStep, invoiceDetails, user, resetState: appContextResetState } = useContext(AppContext);
    useEffect(() => {
        return () => {
            console.log("Leaving confirmation, resetting app state.");
            appContextResetState(); 
        }
    }, [appContextResetState]);
    if (!invoiceDetails) { 
        return (
            <div className="max-w-xl mx-auto p-6 text-center">
                <FileText size={48} className="mx-auto text-gray-400 mb-4" />
                <p className="text-lg text-gray-700">Looking for your order? Registered users can find purchased documents in their dashboard.</p>
                <Button onClick={() => navigateToStep('welcome')} className="mt-4">Go to Homepage</Button>
                 {(!user || user.isAnonymous) && <Button onClick={() => navigateToStep('retrieveOrder')} className="mt-2" variant="outline">Retrieve Order (Non-Registered)</Button>}
            </div>
        );
     }
    
    return (
        <div className="max-w-2xl mx-auto p-6 md:p-8 bg-white shadow-xl rounded-lg text-center">
            <CheckCircle size={64} className="mx-auto text-green-500 mb-6" />
            <h2 className="text-3xl font-bold text-gray-800 mb-3">Thank You for Your Order!</h2>
            <p className="text-gray-600 mb-6">Your OHS System documents have been successfully processed.</p>
            <div className="bg-gray-50 p-6 rounded-lg text-left mb-6 border">
                <h3 className="text-xl font-semibold mb-3">Order Confirmation</h3>
                <p><strong>Reference Number:</strong> <span className="font-mono text-blue-600">{invoiceDetails.reference}</span></p>
                <p><strong>Date:</strong> {invoiceDetails.date}</p>
                <p><strong>Total Amount:</strong> R{invoiceDetails.total.toFixed(2)}</p>
                <p className="mt-2"><strong>Items Purchased:</strong></p>
                <ul className="list-disc list-inside ml-4 text-sm">
                    {invoiceDetails.items.map(item => <li key={item.name}>{item.name}</li>)}
                </ul>
            </div>
            {(!user || user.isAnonymous) && (
                <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-6 text-sm">
                    <AlertTriangle size={20} className="inline mr-2 text-yellow-600" />
                    <strong>Important for Non-Registered Users:</strong> Please save your reference number <strong className="font-mono">{invoiceDetails.reference}</strong>. You will need it to access your documents for the next 7 days.
                    <Button onClick={() => navigateToStep('retrieveOrder')} className="mt-3 w-full" variant="outline">Access Your Documents Now</Button>
                </div>
            )}
            {(user && !user.isAnonymous) && (
                 <p className="text-gray-600 mb-6">Your documents have been saved to your account and are accessible from your dashboard.</p>
            )}
            <div className="flex flex-col sm:flex-row justify-center gap-4">
                <Button onClick={() => { navigateToStep('welcome'); }} variant="primary" iconLeft={<Home size={18}/>}>Return to Homepage</Button>
            </div>
        </div>
    );
};

const RetrieveOrderScreen = () => {
    const { navigateToStep, setInvoiceDetails, setCart, setIsLoading, isLoading, setShowModal, companyInfo, getPublicSpacePath } = useContext(AppContext);
    const [reference, setReference] = useState('');
    const [error, setError] = useState('');
    const handleRetrieve = async () => { 
        if (!reference.trim()) { setError("Please enter your reference number."); return; }
        setError(''); setIsLoading(true);
        try {
            const q = query(collection(db, getPublicSpacePath('tempAccess')), where("reference", "==", reference.trim()));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                const orderData = querySnapshot.docs[0].data();
                const expiresAtDate = orderData.expiresAt?.toDate ? orderData.expiresAt.toDate() : new Date(orderData.expiresAt);
                if (expiresAtDate < new Date()) {
                    setError("This order has expired. Contact support or register for permanent access.");
                    setIsLoading(false); return;
                }
                setInvoiceDetails({
                    reference: orderData.reference, date: orderData.date,
                    items: orderData.purchasedItems.map(item => ({name: item.name, price: item.price})),
                    total: orderData.total,
                    companyName: orderData.companyName || companyInfo?.name || "Valued Customer",
                });
                setCart(orderData.purchasedItems || []);
                navigateToStep('viewRetrievedOrder');
            } else {
                setError("Invalid reference number or order not found.");
            }
        } catch (err) {
            console.error("Error retrieving order:", err);
            setError("An error occurred. Please try again.");
        }
        setIsLoading(false);
    };
    
    return (
        <div className="max-w-md mx-auto p-6 bg-white shadow-xl rounded-lg mt-10">
            <h2 className="text-2xl font-semibold text-gray-800 mb-6 text-center">Retrieve Your Purchased Documents</h2>
            <p className="text-sm text-gray-600 mb-4 text-center">For non-registered users. Enter the reference number provided at checkout.</p>
            <Input 
                label="Reference Number" id="referenceInput" value={reference} 
                onChange={(e) => setReference(e.target.value)} placeholder="e.g., OHS-123456" error={error}
            />
            <Button onClick={handleRetrieve} className="w-full mt-4" disabled={isLoading}>
                {isLoading ? 'Retrieving...' : 'Retrieve Documents'}
            </Button>
            <Button onClick={() => navigateToStep('welcome')} variant="ghost" className="w-full mt-2">Cancel</Button>
            <InfoCard title="7-Day Access" icon={<CalendarDays size={20}/>} className="mt-6">
                <p>Documents for non-registered users are accessible for 7 days. For permanent access, please register.</p>
                <Button onClick={() => setShowModal({type: 'auth', mode: 'register', onSuccess: () => navigateToStep('welcome')})} className="mt-3 w-full" variant="outline">Register Free Account</Button>
            </InfoCard>
        </div>
    );
};

const ViewRetrievedOrderScreen = () => {
    const { navigateToStep, cart, invoiceDetails, setShowModal } = useContext(AppContext);
    
    if (!invoiceDetails || cart.length === 0) { 
        return (
            <div className="max-w-xl mx-auto p-6 text-center">
                <AlertTriangle size={48} className="mx-auto text-orange-500 mb-4" />
                <p className="text-lg text-gray-700">No order details to display or your session has expired.</p>
                <Button onClick={() => navigateToStep('retrieveOrder')} className="mt-4">Try Retrieving Again</Button>
            </div>
        );
     }

    return (
        <div className="max-w-3xl mx-auto p-6 bg-white shadow-xl rounded-lg">
            <h2 className="text-2xl font-semibold mb-4">Your Purchased Documents (Ref: {invoiceDetails.reference})</h2>
            <p className="text-sm text-gray-500 mb-6">These documents are available for 7 days from purchase. You can view them here. For permanent storage, please register.</p>
            <div className="space-y-4">
                {cart.map(doc => (
                    <div key={doc.id} className="p-4 border rounded-lg shadow-sm bg-gray-50">
                        <div className="flex justify-between items-center">
                            <h3 className="text-lg font-medium text-gray-700">{doc.name}</h3>
                            <Button 
                                variant="outline" size="sm" 
                                onClick={() => {
                                    const blob = new Blob([doc.content || 'No content available.'], { type: 'text/html;charset=utf-8' });
                                    const link = document.createElement('a');
                                    link.href = URL.createObjectURL(blob);
                                    link.download = `${doc.name.replace(/\s+/g, '_')}.html`;
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                    URL.revokeObjectURL(link.href);
                                    setShowModal({type: 'success', title: 'Download Started', message: `${doc.name} should begin downloading.`});
                                }} 
                                iconLeft={<Download size={16}/>}
                            >
                                Download
                            </Button>
                        </div>
                        <div className="mt-2 p-3 bg-white border rounded max-h-60 overflow-y-auto text-sm" dangerouslySetInnerHTML={{ __html: doc.content?.substring(0, 500) + (doc.content?.length > 500 ? '...' : '') }} />
                    </div>
                ))}
            </div>
             <InfoCard title="Access & Storage" icon={<Save size={20}/>} className="mt-6">
                <p>Remember, this temporary access expires in 7 days. To ensure you don't lose your documents and for easier management, we highly recommend creating a free account.</p>
                 <Button onClick={() => setShowModal({type: 'auth', mode: 'register', onSuccess: () => navigateToStep('welcome')})} className="mt-3 w-full" variant="success">Register for Permanent Access</Button>
            </InfoCard>
            <Button onClick={() => navigateToStep('welcome')} className="mt-8" iconLeft={<Home size={18}/>}>
                Back to Homepage
            </Button>
        </div>
    );
};

function App() {
    const { currentStep, user, setUser, userId, isAuthReady, showModal, setShowModal, handleGoToMain, saveSystemData, isLoading, navigateToStep } = useContext(AppContext);

    const handleLogout = async () => { 
        try {
            await signOut(auth); // Use auth from global scope
            setUser(null); 
            setShowModal(null);
        } catch (error) {
            console.error("Error signing out: ", error);
            setShowModal({type: 'error', title: 'Logout Error', message: 'Could not log out. Please try again.'});
        }
    };
    
    const renderCurrentStep = () => { 
        switch (currentStep) {
            case 'welcome': return <WelcomeScreen />;
            case 'report': return <OHSComplianceReport />;
            case 'wizard': return <AutomatedWizard />;
            case 'manual': return <ManualDocumentSelection />;
            case 'companyInfo': return <CompanyInformationStep />;
            case 'personInfo': return <PersonCompilingStep />;
            case 'previewDocs': return <DocumentPreviewScreen />;
            case 'cart': return <CartScreen />;
            case 'checkout': return <CheckoutScreen />;
            case 'confirmation': return <ConfirmationScreen />;
            case 'retrieveOrder': return <RetrieveOrderScreen />;
            case 'viewRetrievedOrder': return <ViewRetrievedOrderScreen />;
            case 'login': 
            case 'register':
                return <AuthModal 
                            mode={currentStep} 
                            onSuccess={() => { setShowModal(null); navigateToStep('welcome');}} 
                            onSwitchMode={() => navigateToStep(currentStep === 'login' ? 'register' : 'login')} 
                            onClose={() => navigateToStep('welcome')} 
                        />;
            default: return <div className="text-center p-10"><AlertTriangle className="mx-auto mb-2" /> <p>Page not found or an error occurred (Step: {currentStep}).</p> <Button onClick={() => navigateToStep('welcome')}>Go Home</Button></div>;
        }
    };

    if (!isAuthReady) { 
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
                <RotateCcw className="animate-spin text-blue-600 mr-3" size={32} />
                <p className="text-lg text-gray-700">Loading Safety System Builder...</p>
            </div>
        );
    }
    
    return (
        <div className="font-sans bg-gray-100 min-h-screen flex flex-col">
            <header className="bg-white shadow-md sticky top-0 z-40">
                <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex items-center justify-between h-20">
                        <div className="flex items-center cursor-pointer" onClick={handleGoToMain}>
                            <ShieldCheck size={32} className="text-blue-600" />
                            <span className="ml-3 text-2xl font-bold text-gray-800">OHS Site Builder</span>
                        </div>
                        <nav className="flex items-center space-x-1 sm:space-x-2 md:space-x-3"> 
                            {user && !user.isAnonymous && (
                                <>
                                    <span className="text-sm text-gray-600 hidden md:inline">Welcome, {user.email?.split('@')[0] || 'User'}!</span>
                                    <Button onClick={() => setShowModal({type: 'logoutConfirm'})} variant="ghost" size="sm" className="px-2 py-2 sm:px-3" iconLeft={<LogOut size={16}/>}><span className="hidden sm:inline">Logout</span></Button>
                                </>
                            )}
                            {(!user || user.isAnonymous) && (
                                <>
                                    <Button onClick={() => setShowModal({type: 'auth', mode: 'login'})} variant="outline" size="sm" className="px-2 py-2 sm:px-3" iconLeft={<LogIn size={16}/>}><span className="hidden sm:inline">Login</span></Button>
                                    <Button onClick={() => setShowModal({type: 'auth', mode: 'register'})} variant="primary" size="sm" className="px-2 py-2 sm:px-3" iconLeft={<UserPlus size={16}/>}><span className="hidden sm:inline">Register</span></Button>
                                </>
                            )}
                             <Button onClick={saveSystemData} variant="ghost" size="sm" className="px-2 py-2 sm:px-3" iconLeft={<Save size={16}/>} disabled={isLoading || (!user || user.isAnonymous)}>
                                {isLoading ? <RotateCcw className="animate-spin" size={16}/> : <span className="hidden sm:inline">Save</span>}
                                <span className="sm:hidden">{isLoading ? <RotateCcw className="animate-spin" size={16}/> : "Save"}</span>
                            </Button>
                        </nav>
                    </div>
                </div>
            </header>
            <main className="container mx-auto p-4 sm:p-6 lg:p-8 mt-4 mb-8 flex-grow">
                {renderCurrentStep()}
            </main>
            <footer className="bg-gray-800 text-white py-8 text-center">
                <p>&copy; {new Date().getFullYear()} OHS System Builder. All rights reserved.</p>
                <p className="text-sm text-gray-400 mt-1">Your partner in Occupational Health and Safety compliance.</p>
                 {userId && <p className="text-xs text-gray-500 mt-2">User ID: {userId} (App ID: {currentAppId})</p>}
            </footer>
            
            {showModal?.type === 'auth' && (
                <AuthModal 
                    mode={showModal.mode} 
                    onSuccess={() => { setShowModal(null); if(showModal.onSuccess) showModal.onSuccess(); }} 
                    onSwitchMode={() => setShowModal(prev => ({...prev, mode: prev.mode === 'login' ? 'register' : 'login'}))}
                    onClose={() => setShowModal(null)}
                />
            )}
            {showModal?.type === 'logoutConfirm' && (
                <Modal title="Confirm Logout" onClose={() => setShowModal(null)} footer={
                    <>
                        <Button onClick={() => setShowModal(null)} variant="secondary">Cancel</Button>
                        <Button onClick={handleLogout} variant="danger">Logout</Button>
                    </>
                }>
                    <p>Are you sure you want to logout?</p>
                </Modal>
            )}
            {showModal?.type === 'saveOrLoseProgress' && (
                <Modal title={showModal.title} onClose={showModal.onCancel} footer={
                    <>
                        <Button onClick={showModal.onCancel} variant="secondary">Cancel</Button>
                        <Button onClick={showModal.onDiscard} variant="outline">Discard Progress</Button>
                        <Button onClick={showModal.onSave} variant="primary" iconLeft={<Save size={16}/>}>Save Progress</Button>
                    </>
                }>
                    <p>{showModal.message}</p>
                </Modal>
            )}
            {showModal?.type === 'registerToSave' && (
                <Modal title={showModal.title} onClose={showModal.onCancel} footer={
                    <>
                        <Button onClick={showModal.onCancel} variant="secondary">Later</Button>
                        <Button onClick={showModal.onConfirm} variant="success" iconLeft={<UserPlus size={16}/>}>Register Now</Button>
                    </>
                }>
                    <p>{showModal.message}</p>
                </Modal>
            )}
             {showModal?.type === 'success' && (
                <Modal title={showModal.title} onClose={() => setShowModal(null)} footer={<Button onClick={() => setShowModal(null)}>OK</Button>}>
                    <div className="flex items-center">
                        <CheckCircle size={32} className="text-green-500 mr-3" />
                        <p>{showModal.message}</p>
                    </div>
                </Modal>
            )}
            {showModal?.type === 'error' && (
                <Modal title={showModal.title} onClose={() => setShowModal(null)} footer={<Button onClick={() => setShowModal(null)}>OK</Button>}>
                     <div className="flex items-center">
                        <AlertTriangle size={32} className="text-red-500 mr-3" />
                        <p>{showModal.message}</p>
                    </div>
                </Modal>
            )}
            {isLoading && (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000]">
                    <div className="bg-white p-6 rounded-lg shadow-xl flex items-center">
                        <RotateCcw className="animate-spin text-blue-600" size={32} />
                        <p className="ml-4 text-lg text-blue-700">Processing...</p>
                    </div>
                </div>
            )}
        </div>
    );
}

const AppWrapper = () => (
    <AppProvider>
        <App />
    </AppProvider>
);
export default AppWrapper;
